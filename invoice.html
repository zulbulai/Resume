<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zulbulai — Invoice (Auto images)</title>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{--accent:#f6a800; --navy:#131844; --muted:#6b7280; --bg:#f4f6fb}
  body{font-family:Arial, sans-serif; background:var(--bg); margin:0; padding:18px; color:#111}
  .container{max-width:1100px;margin:12px auto;display:grid;grid-template-columns:360px 1fr;gap:14px}
  .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(3,10,34,0.06)}
  h3{margin:0 0 8px 0}
  label{font-size:13px;color:var(--muted);display:block;margin-top:8px}
  input[type=text], input[type=email], input[type=tel], select{width:100%;padding:8px;border:1px solid #e6e9f0;border-radius:6px;box-sizing:border-box}
  .btn{background:var(--navy);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn.secondary{background:var(--accent);color:#111}
  .muted{color:var(--muted);font-size:13px}
  .invoice-sheet{background:#fff;padding:22px;border-radius:6px}
  .inv-head{display:flex;justify-content:space-between;align-items:flex-start}
  .logo{max-width:140px;max-height:70px;object-fit:contain}
  .accent-bar{height:10px;background:var(--accent);width:100%;margin-top:8px;border-radius:4px}
  .title{font-size:34px;color:var(--navy);font-weight:700;margin:18px 0}
  table.items{width:100%;border-collapse:collapse;margin-top:12px}
  table.items th, table.items td{border:1px solid #e6e9f0;padding:10px;font-size:13px}
  table.items th{background:var(--navy);color:#fff;font-weight:700;font-size:12px}
  .right-sum{float:right;width:240px;margin-top:12px}
  .sum-row{display:flex;justify-content:space-between;padding:8px 10px;border:1px solid #e6e9f0;margin-bottom:8px;background:#fff}
  .payment-box{display:flex;gap:12px;align-items:center;margin-top:14px}
  .qr{max-width:120px;border:1px solid #eee;padding:6px;background:#fff}
  .signature{max-width:200px; display:block}
  footer.note{border-top:3px solid var(--navy);padding-top:10px;margin-top:18px;font-size:13px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
  .small-muted{font-size:12px;color:var(--muted)}
  @media(max-width:900px){.container{grid-template-columns:1fr;}.right-sum{float:none;width:100%}}
</style>
</head>
<body>

<div class="container">
  <!-- LEFT: minimal form -->
  <div class="card">
    <h3>Quick Invoice — Fill only customer & plan</h3>
    <div class="small-muted">Auto-filled: Zulbulai — kanpur उत्तर प्रदेश 208004 — zulbulai@gmail.com</div>

    <label>Customer Name</label>
    <input id="cust_name" type="text" placeholder="Customer name">

    <label>Customer Email</label>
    <input id="cust_email" type="email" placeholder="customer@example.com">

    <label>Customer Phone</label>
    <input id="cust_phone" type="tel" placeholder="10-digit phone">

    <label>Subscription plan</label>
    <select id="plan_select">
      <option value="0">Select plan — amount auto-set</option>
      <option value="499">Basic — ₹499</option>
      <option value="999">Standard — ₹999</option>
      <option value="1999">Premium — ₹1999</option>
      <option value="4999">Enterprise — ₹4999</option>
    </select>

    <label style="margin-top:10px">Invoice No (auto)</label>
    <input id="invoice_no" type="text" value="">

    <label style="margin-top:10px">Invoice Date</label>
    <input id="invoice_date" type="date">

    <label style="margin-top:10px">(Optional) GitHub raw base URL for images</label>
    <input id="github_raw" type="text" placeholder="https://raw.githubusercontent.com/username/repo/branch/path/to/folder/">

    <label style="margin-top:10px">(Fallback) Upload logo / signature / qr</label>
    <input id="logo_file" type="file" accept="image/*" style="margin-top:6px">
    <input id="signature_file" type="file" accept="image/*" style="margin-top:6px">
    <input id="qr_file" type="file" accept="image/*" style="margin-top:6px">

    <div style="margin-top:12px; display:flex; gap:8px;">
      <button id="preview_btn" class="btn">Refresh Preview</button>
      <button id="download_btn" class="btn secondary" style="margin-left:auto">Download PDF</button>
    </div>

    <div style="margin-top:10px; font-size:13px;" class="muted">
      Payment: UPI — <strong>Canvapro@upi</strong><br>
      Phone: <strong>6387617678</strong>
    </div>

    <div style="margin-top:8px" class="small-muted">Notes: Images will be tried from GitHub raw base (if set), then relative path (./logo.png etc.), then uploaded files.</div>
  </div>

  <!-- RIGHT: Invoice preview -->
  <div class="invoice-sheet" id="invoice_area">
    <div class="inv-head">
      <div style="max-width:60%">
        <img id="logo_img" class="logo" src="" alt="logo" style="display:none">
        <div class="accent-bar"></div>
      </div>
      <div style="text-align:right">
        <div style="font-size:14px;color:var(--muted)">Invoice</div>
        <div id="display_invoice_no" style="font-weight:700;font-size:18px">INV-0001</div>
        <div id="display_date" class="muted"></div>
      </div>
    </div>

    <div class="title">INVOICE</div>

    <div style="display:flex;justify-content:space-between;gap:12px;">
      <div style="width:55%">
        <div style="font-weight:700">INVOICE TO</div>
        <div style="margin-top:8px"><strong id="p_cust_name">Customer Name</strong></div>
        <div id="p_cust_phone" class="muted"></div>
        <div id="p_cust_email" class="muted"></div>
        <div style="margin-top:10px" class="muted">Company: <strong>Zulbulai</strong><br>kanpur उत्तर प्रदेश 208004</div>
      </div>

      <div style="width:40%">
        <div style="font-weight:700">INVOICE DETAILS</div>
        <div style="margin-top:8px" class="muted">Invoice No: <span id="p_invoice_no">INV-0001</span></div>
        <div class="muted">Date: <span id="p_invoice_date">--/--/----</span></div>

        <div class="right-sum" id="sums">
          <div class="sum-row"><div>Sub Total</div><div id="p_subtotal">0.00</div></div>
          <div class="sum-row"><div>Tax (0%)</div><div id="p_tax">0.00</div></div>
          <div class="sum-row" style="background:#f8fafc"><div><strong>Total</strong></div><div><strong id="p_total">0.00</strong></div></div>
        </div>
      </div>
    </div>

    <table class="items" aria-hidden="false" style="margin-top:18px">
      <thead><tr><th style="width:8%">SL NO</th><th>DESCRIPTION</th><th style="width:18%">QTY</th><th style="width:18%">PRICE</th><th style="width:18%">TOTAL</th></tr></thead>
      <tbody id="p_items">
        <tr><td>1</td><td>Subscription Plan</td><td>1</td><td id="p_price">0.00</td><td id="p_line_total">0.00</td></tr>
      </tbody>
    </table>

    <div class="payment-box">
      <div>
        <div style="font-weight:700">Payment (UPI)</div>
        <div class="muted" style="margin-top:6px">UPI ID: <strong>Canvapro@upi</strong></div>
        <div class="muted">Phone: <strong>6387617678</strong></div>
      </div>
      <div style="margin-left:auto; text-align:center;">
        <img id="qr_preview" class="qr" src="" alt="QR" style="display:none">
        <div class="muted" style="margin-top:6px">Scan to Pay</div>
      </div>
    </div>

    <div style="margin-top:16px; display:flex; justify-content:space-between; align-items:center;">
      <div class="muted">Email: zulbulai@gmail.com</div>
      <div style="font-weight:700;color:var(--accent)">THANKS FOR YOUR BUSINESS</div>
    </div>

    <div style="margin-top:18px; text-align:right;">
      <img id="sig_preview" class="signature" src="" alt="signature" style="display:none">
      <div style="font-weight:700;color:var(--accent)" id="sig_name">Authorized Signatory</div>
    </div>

    <footer class="note">
      <div>Terms: Payment due on receipt. For queries contact 6387617678</div>
      <div style="font-weight:700">Zulbulai</div>
    </footer>
  </div>

</div>

<script>
/*
  Behavior:
  - Tries to load images in this order:
    1) If user provided GitHub raw base URL in input, tries base + logo.png / signature.png / qr.png
    2) Then tries relative path './logo.png' etc.
    3) Then uses uploaded files (file inputs) if provided.
  - Auto-increments invoice number using localStorage for simplicity.
*/

(function(){
  // CONFIG: Edit here if you want hard-coded GitHub raw base by default
  const GITHUB_RAW_BASE_DEFAULT = ''; // e.g. 'https://raw.githubusercontent.com/username/repo/branch/path/'

  // DOM
  const githubRawInput = document.getElementById('github_raw');
  const logoFileInput = document.getElementById('logo_file');
  const signatureFileInput = document.getElementById('signature_file');
  const qrFileInput = document.getElementById('qr_file');

  const logoImg = document.getElementById('logo_img');
  const sigPreview = document.getElementById('sig_preview');
  const qrPreview = document.getElementById('qr_preview');

  const custName = document.getElementById('cust_name');
  const custEmail = document.getElementById('cust_email');
  const custPhone = document.getElementById('cust_phone');
  const planSelect = document.getElementById('plan_select');
  const invoiceNoInput = document.getElementById('invoice_no');
  const invoiceDateInput = document.getElementById('invoice_date');

  const p_cust_name = document.getElementById('p_cust_name');
  const p_cust_email = document.getElementById('p_cust_email');
  const p_cust_phone = document.getElementById('p_cust_phone');
  const p_invoice_no = document.getElementById('p_invoice_no');
  const p_invoice_date = document.getElementById('p_invoice_date');
  const p_price = document.getElementById('p_price');
  const p_line_total = document.getElementById('p_line_total');
  const p_subtotal = document.getElementById('p_subtotal');
  const p_tax = document.getElementById('p_tax');
  const p_total = document.getElementById('p_total');
  const display_invoice_no = document.getElementById('display_invoice_no');
  const display_date = document.getElementById('display_date');

  const previewBtn = document.getElementById('preview_btn');
  const downloadBtn = document.getElementById('download_btn');

  // defaults
  const COMPANY = {
    name: 'Zulbulai',
    addr: 'kanpur उत्तर प्रदेश 208004',
    email: 'zulbulai@gmail.com',
    phone: '6387617678',
    upi: 'Canvapro@upi'
  };

  // utility: try loading image from list of sources sequentially
  function tryLoadImageSequential(imgElement, candidates) {
    return new Promise((resolve) => {
      let idx = 0;
      function tryNext() {
        if (idx >= candidates.length) {
          imgElement.style.display = 'none';
          imgElement.src = '';
          resolve(false);
          return;
        }
        const src = candidates[idx++];
        if (!src) { tryNext(); return; }
        // Set up temporary handlers
        let done = false;
        function success(){
          if(done) return; done = true;
          imgElement.style.display = 'block';
          resolve(true);
        }
        function failure(){
          if(done) return; done = true;
          // try next
          tryNext();
        }
        // Attach onload/onerror
        imgElement.onload = success;
        imgElement.onerror = failure;
        // start attempt
        imgElement.src = src;
        // add timeout fallback (6s)
        setTimeout(function(){
          if(done) return;
          // if still not loaded, consider failure
          done = true;
          imgElement.onerror = null;
          imgElement.onload = null;
          tryNext();
        }, 6000);
      }
      tryNext();
    });
  }

  // build candidate URLs for each image name
  function buildCandidates(base, filename) {
    const list = [];
    if (base) {
      // ensure base ends with slash
      if (!base.endsWith('/')) base = base + '/';
      list.push(base + filename);
    }
    // relative path (same folder)
    list.push('./' + filename);
    list.push(filename);
    return list;
  }

  // read local file input to dataURL
  function fileInputToDataUrl(fileInput) {
    return new Promise((resolve) => {
      const f = fileInput.files && fileInput.files[0];
      if (!f) { resolve(null); return; }
      const rdr = new FileReader();
      rdr.onload = function(ev){ resolve(ev.target.result); };
      rdr.onerror = function(){ resolve(null); };
      rdr.readAsDataURL(f);
    });
  }

  // initial: set invoice no (localStorage increment)
  function initInvoiceNo() {
    const key = 'zulbulai_invoice_counter_v1';
    let counter = Number(localStorage.getItem(key) || 0);
    counter = counter + 1;
    localStorage.setItem(key, String(counter));
    const inv = 'ZUL-' + String(new Date().getFullYear()).slice(2) + '-' + String(counter).padStart(4,'0');
    invoiceNoInput.value = inv;
  }

  // date default
  if (!invoiceDateInput.value) invoiceDateInput.value = new Date().toISOString().slice(0,10);

  // main image auto-load flow
  async function attemptAutoLoadImages() {
    const baseFromInput = (githubRawInput.value || '').trim() || GITHUB_RAW_BASE_DEFAULT;
    // LOGO
    let candidatesLogo = buildCandidates(baseFromInput, 'logo.png');
    // For signature and QR
    let candidatesSig = buildCandidates(baseFromInput, 'signature.png');
    let candidatesQr = buildCandidates(baseFromInput, 'qr.png');

    // try Github/raw and relative candidates first
    let logoLoaded = await tryLoadImageSequential(logoImg, candidatesLogo);
    let sigLoaded = await tryLoadImageSequential(sigPreview, candidatesSig);
    let qrLoaded = await tryLoadImageSequential(qrPreview, candidatesQr);

    // if any not loaded, but user has uploaded file, use that
    if (!logoLoaded && logoFileInput.files.length) {
      const data = await fileInputToDataUrl(logoFileInput);
      if (data) { logoImg.src = data; logoImg.style.display = 'block'; logoLoaded = true; }
    }
    if (!sigLoaded && signatureFileInput.files.length) {
      const data = await fileInputToDataUrl(signatureFileInput);
      if (data) { sigPreview.src = data; sigPreview.style.display = 'block'; sigLoaded = true; }
    }
    if (!qrLoaded && qrFileInput.files.length) {
      const data = await fileInputToDataUrl(qrFileInput);
      if (data) { qrPreview.src = data; qrPreview.style.display = 'block'; qrLoaded = true; }
    }

    // final: if still not loaded, hide elements
    if (!logoLoaded) { logoImg.style.display = 'none'; }
    if (!sigLoaded) { sigPreview.style.display = 'none'; }
    if (!qrLoaded) { qrPreview.style.display = 'none'; }
  }

  // wire local file change -> show preview immediately
  logoFileInput.addEventListener('change', async function(){ const d = await fileInputToDataUrl(logoFileInput); if (d) { logoImg.src = d; logoImg.style.display='block'; }});
  signatureFileInput.addEventListener('change', async function(){ const d = await fileInputToDataUrl(signatureFileInput); if (d) { sigPreview.src = d; sigPreview.style.display='block'; }});
  qrFileInput.addEventListener('change', async function(){ const d = await fileInputToDataUrl(qrFileInput); if (d) { qrPreview.src = d; qrPreview.style.display='block'; }});

  // update amounts / preview
  function money(v){ return Number(v||0).toFixed(2); }

  function refreshPreview() {
    p_cust_name.textContent = custName.value || 'Customer Name';
    p_cust_email.textContent = custEmail.value || '';
    p_cust_phone.textContent = custPhone.value || '';
    p_invoice_no.textContent = invoiceNoInput.value || '';
    display_invoice_no.textContent = invoiceNoInput.value || '';
    p_invoice_date.textContent = invoiceDateInput.value || '';
    display_date.textContent = invoiceDateInput.value || '';

    const amt = Number(planSelect.value || 0);
    p_price.textContent = money(amt);
    p_line_total.textContent = money(amt);
    p_subtotal.textContent = money(amt);
    const tax = 0;
    p_tax.textContent = money(amt * tax / 100);
    p_total.textContent = money(amt + (amt * tax / 100));
  }

  // initial invoice no and images
  initInvoiceNo();
  attemptAutoLoadImages();
  refreshPreview();

  // wire inputs
  [custName, custEmail, custPhone, planSelect, invoiceNoInput, invoiceDateInput, githubRawInput].forEach(el => {
    el.addEventListener('input', refreshPreview);
  });

  previewBtn.addEventListener('click', async function(e){
    e.preventDefault();
    // if user changed github raw input, try reload images again
    await attemptAutoLoadImages();
    refreshPreview();
    alert('Preview refreshed (images attempted from GitHub/raw, relative path, then uploaded files).');
  });

  // download PDF
  downloadBtn.addEventListener('click', async function(e){
    e.preventDefault();
    // simple validation
    if (!custName.value.trim()) { alert('Please enter customer name'); return; }
    if (!planSelect.value || Number(planSelect.value) === 0) { if (!confirm('Plan not selected or amount 0. Continue?')) return; }

    // make sure images are attempted to load before rendering
    await attemptAutoLoadImages();
    refreshPreview();

    downloadBtn.disabled = true; downloadBtn.textContent = 'Preparing PDF...';

    try {
      const invoiceEl = document.getElementById('invoice_area');

      // Workaround: ensure images are loaded (wait if any image is still loading)
      await new Promise(resolve => setTimeout(resolve, 300)); // small delay to let images settle

      const scale = 2; // increase for higher quality (memory cost)
      const opts = { scale: scale, useCORS: true, allowTaint: true, backgroundColor: '#ffffff' };
      const canvas = await html2canvas(invoiceEl, opts);

      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: 'mm', format: 'a4' });

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 10;
      const availW = pageW - margin * 2;
      const availH = pageH - margin * 2;

      const pxToMm = 0.264583 * (1/scale);
      const imgW = canvas.width * pxToMm;
      const imgH = canvas.height * pxToMm;

      let renderW = imgW, renderH = imgH;
      if (renderW > availW) { const r = availW / renderW; renderW = availW; renderH = renderH * r; }
      if (renderH > availH) { const r = availH / renderH; renderH = availH; renderW = renderW * r; }

      const x = (pageW - renderW) / 2;
      const y = margin + ((availH - renderH) / 2);

      pdf.addImage(imgData, 'JPEG', x, y, renderW, renderH, undefined, 'FAST');

      const fname = (invoiceNoInput.value || 'invoice') + '-' + (new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-') + '.pdf';
      pdf.save(fname);

      // increment local storage counter (so next invoice will be higher)
      // we already incremented in init; optionally increment here for multiple generation
      // localStorage counter remains consistent.

    } catch (err) {
      console.error('PDF error', err);
      alert('PDF generation failed: ' + (err && err.message ? err.message : String(err)));
    } finally {
      downloadBtn.disabled = false; downloadBtn.textContent = 'Download PDF';
    }
  });

})();
</script>

</body>
</html>
