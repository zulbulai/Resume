<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Camva Pro | Action Center</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        /* Animations */
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        // CONFIG
        const API_URL = "https://script.google.com/macros/s/AKfycbyEv15qA-6DjcD54I-qt9aHbL6RmZo5_rSUO0KFaMw7NjGQw2c2WJv7WLd52YavIGOD/exec";
        const SUPPORT_PHONE = "+91 6387617678";

        const { useState, useEffect, useMemo, useRef } = React;

        // --- SAFE ICON COMPONENT ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = ''; 
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.setAttribute('width', size);
                    i.setAttribute('height', size);
                    if (className) i.setAttribute('class', className);
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current });
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        // --- HELPERS ---
        const parseDate = (dStr) => {
            if (!dStr) return new Date();
            let d = new Date(dStr);
            if (!isNaN(d.getTime())) return d;
            const p = String(dStr).match(/(\d+)/g);
            if (!p || p.length < 3) return new Date();
            if (p[0].length === 4) return new Date(p[0], p[1]-1, p[2]);
            if (p[2].length === 4) return new Date(p[2], p[1]-1, p[0]);
            return new Date();
        };

        const getDaysLeft = (expiry) => {
            const today = new Date(); today.setHours(0,0,0,0);
            const exp = parseDate(expiry); exp.setHours(0,0,0,0);
            return Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
        };

        const formatDate = (d) => {
            const date = parseDate(d);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        };

        // --- APP ---
        const App = () => {
            const [customers, setCustomers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [search, setSearch] = useState('');
            const [filter, setFilter] = useState('all');
            const [selectedUser, setSelectedUser] = useState(null);

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const res = await fetch(API_URL);
                        const json = await res.json();
                        if(json.status === 'success') setCustomers(json.data.reverse());
                    } catch (e) { console.error(e); } finally { setLoading(false); }
                };
                fetchData();
            }, []);

            const filteredData = useMemo(() => {
                return customers.filter(c => {
                    const matchSearch = c.name.toLowerCase().includes(search.toLowerCase()) || String(c.phone).includes(search);
                    if(!matchSearch) return false;
                    const days = getDaysLeft(c.expiry);
                    if(filter === 'expired') return days < 0;
                    if(filter === 'urgent') return days >= 0 && days <= 7;
                    if(filter === 'active') return days > 7;
                    return true;
                });
            }, [customers, search, filter]);

            const counts = useMemo(() => {
                const total = customers.length;
                const expired = customers.filter(c => getDaysLeft(c.expiry) < 0).length;
                const urgent = customers.filter(c => { const d = getDaysLeft(c.expiry); return d >= 0 && d <= 7 }).length;
                const active = total - expired;
                return { total, expired, urgent, active };
            }, [customers]);

            const sendMsg = (template) => {
                if (!selectedUser) return;
                const u = selectedUser;
                const name = u.name.split(' ')[0];
                const exp = formatDate(u.expiry);
                const days = getDaysLeft(u.expiry);
                let msg = "";

                switch(template) {
                    case 'welcome': msg = `üéâ *Welcome to Camva Pro, ${name}!*\n\nYour ${u.plan} subscription is now active.\n‚úÖ Plan: ${u.plan}\nüìÖ Valid Until: ${exp}\n\nStart creating now! üöÄ\n\nSupport: ${SUPPORT_PHONE}`; break;
                    case 'start': msg = `üöÄ *Subscription Activated - ${u.name}*\n\nYour Canva Pro ${u.plan} subscription is now live!\n\nüì¶ Plan: ${u.plan}\nüìÖ Valid Until: ${exp}\n‚ú® All features unlocked\n\nSupport: ${SUPPORT_PHONE}`; break;
                    case 'renew': msg = `‚úÖ *Subscription Renewed Successfully!*\n\nHi ${name}, great news! Your Camva Pro subscription has been renewed.\n\nüîÑ New Plan: ${u.plan}\nüìÖ Valid Until: ${exp}\n\nQuestions? Contact: ${SUPPORT_PHONE}`; break;
                    case 'reminder': msg = `‚è∞ *Subscription Reminder - ${name}*\n\nYour plan expires in *${days} days*.\nüìÖ Expiry: ${exp}\nüì¶ Plan: ${u.plan}\n\nRenew now to avoid service interruption!\n\nContact: ${SUPPORT_PHONE}`; break;
                    case 'expired': msg = `‚ö†Ô∏è *Subscription Expired - ${name}*\n\nYour plan has expired on ${exp}.\nüö´ Premium features are locked.\n\nRenew now to restore full access.\nContact: ${SUPPORT_PHONE}`; break;
                    case 'status': msg = `Hi ${name}!\n\nYour status update:\n‚úÖ Account: ${days < 0 ? 'EXPIRED' : 'ACTIVE'}\nüì¶ Plan: ${u.plan}\nüé® Access: Premium\n\nNeed help? Contact: ${SUPPORT_PHONE}`; break;
                }
                const phone = "91" + String(u.phone).replace(/\D/g, '').slice(-10);
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            };

            if (loading) return (
                <div className="h-screen w-full flex flex-col items-center justify-center bg-white text-indigo-600">
                    <Icon name="loader-2" size={40} className="animate-spin mb-4" />
                    <p className="text-sm font-bold tracking-widest uppercase">Loading Database...</p>
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-slate-50 relative max-w-md mx-auto md:max-w-full md:flex-row shadow-2xl overflow-hidden">
                    
                    {/* --- MAIN LIST VIEW --- */}
                    <div className="flex-1 flex flex-col h-full overflow-hidden bg-white">
                        
                        {/* Header & Search */}
                        <div className="px-5 pt-6 pb-2 bg-white sticky top-0 z-10">
                            <div className="flex justify-between items-center mb-4">
                                <h1 className="text-2xl font-bold text-slate-800 tracking-tight">Action Center</h1>
                                <div className="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold border border-indigo-100">
                                    {filteredData.length}
                                </div>
                            </div>
                            
                            <div className="relative shadow-sm">
                                <Icon name="search" className="absolute left-3 top-3 text-slate-400" size={18} />
                                <input 
                                    type="text" 
                                    placeholder="Search name or phone..." 
                                    className="w-full bg-slate-50 pl-10 pr-4 py-3 rounded-2xl border-none outline-none focus:ring-2 focus:ring-indigo-500 transition text-slate-700 font-medium"
                                    value={search}
                                    onChange={e => setSearch(e.target.value)}
                                />
                            </div>
                        </div>

                        {/* Filter Pills */}
                        <div className="px-5 py-2 flex gap-3 overflow-x-auto no-scrollbar sticky top-[100px] z-10 bg-white/95 backdrop-blur-sm pb-4 border-b border-slate-100">
                            <FilterChip label="All" count={counts.total} active={filter==='all'} onClick={()=>setFilter('all')} />
                            <FilterChip label="Urgent" count={counts.urgent} active={filter==='urgent'} onClick={()=>setFilter('urgent')} color="orange" />
                            <FilterChip label="Expired" count={counts.expired} active={filter==='expired'} onClick={()=>setFilter('expired')} color="red" />
                            <FilterChip label="Active" count={counts.active} active={filter==='active'} onClick={()=>setFilter('active')} color="green" />
                        </div>

                        {/* Customer List */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-24 bg-slate-50">
                            {filteredData.length === 0 ? (
                                <div className="flex flex-col items-center justify-center h-64 text-slate-400">
                                    <Icon name="search-x" size={48} className="mb-2 opacity-50" />
                                    <p>No customers found.</p>
                                </div>
                            ) : (
                                filteredData.map(user => {
                                    const days = getDaysLeft(user.expiry);
                                    const isExpired = days < 0;
                                    
                                    return (
                                        <div 
                                            key={user.id}
                                            onClick={() => setSelectedUser(user)}
                                            className={`bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition-transform flex items-center gap-4 relative overflow-hidden ${isExpired ? 'border-l-4 border-l-red-500' : 'border-l-4 border-l-emerald-500'}`}
                                        >
                                            <div className={`w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold ${isExpired ? 'bg-red-50 text-red-600' : 'bg-slate-100 text-slate-500'}`}>
                                                {user.name ? user.name.charAt(0) : 'U'}
                                            </div>
                                            <div className="flex-1">
                                                <div className="flex justify-between items-start">
                                                    <h3 className="font-bold text-slate-800">{user.name}</h3>
                                                    {isExpired ? 
                                                        <span className="text-[10px] font-bold bg-red-100 text-red-600 px-2 py-0.5 rounded">EXP</span> : 
                                                        <span className="text-[10px] font-bold bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded">{days} Days</span>
                                                    }
                                                </div>
                                                <div className="flex gap-3 text-xs text-slate-500 mt-1">
                                                    <span className="flex items-center gap-1"><Icon name="box" size={12}/> {user.plan}</span>
                                                    <span className="flex items-center gap-1"><Icon name="calendar" size={12}/> {formatDate(user.expiry)}</span>
                                                </div>
                                            </div>
                                            <Icon name="chevron-right" className="text-slate-300" />
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>

                    {/* --- BOTTOM SHEET (MESSAGE ACTIONS) --- */}
                    {selectedUser && (
                        <div className="fixed inset-0 z-50 flex items-end justify-center sm:items-center">
                            {/* Overlay */}
                            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm fade-in" onClick={() => setSelectedUser(null)}></div>
                            
                            {/* Sheet Content */}
                            <div className="relative bg-white w-full max-w-md sm:rounded-2xl rounded-t-3xl shadow-2xl slide-up overflow-hidden max-h-[85vh] flex flex-col">
                                
                                {/* Sheet Header */}
                                <div className="p-6 pb-4 border-b border-slate-100 bg-white sticky top-0 z-10">
                                    <div className="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-4"></div>
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h2 className="text-xl font-bold text-slate-800">{selectedUser.name}</h2>
                                            <p className="text-sm text-slate-500 flex items-center gap-2 mt-1">
                                                <Icon name="phone" size={14}/> {selectedUser.phone}
                                            </p>
                                        </div>
                                        <button onClick={() => setSelectedUser(null)} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition">
                                            <Icon name="x" size={20} className="text-slate-600" />
                                        </button>
                                    </div>
                                </div>

                                {/* Templates Grid */}
                                <div className="p-6 overflow-y-auto bg-slate-50 flex-1">
                                    <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Select Message</p>
                                    
                                    {/* FIX: Using Solid Colors + White Text 
                                      to ensure visibility against any background 
                                    */}
                                    <div className="grid grid-cols-2 gap-3 mb-6">
                                        <TemplateBtn title="Welcome" icon="sparkles" color="blue" onClick={() => sendMsg('welcome')} />
                                        <TemplateBtn title="Activated" icon="rocket" color="purple" onClick={() => sendMsg('start')} />
                                        <TemplateBtn title="Renewed" icon="check-circle" color="green" onClick={() => sendMsg('renew')} />
                                        <TemplateBtn title="Status" icon="info" color="cyan" onClick={() => sendMsg('status')} />
                                    </div>

                                    <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Priority Actions</p>
                                    <div className="space-y-3">
                                        <button onClick={() => sendMsg('reminder')} className="w-full bg-white p-4 rounded-xl border border-orange-200 shadow-sm flex items-center justify-between active:scale-[0.98] transition group hover:bg-orange-50">
                                            <div className="flex items-center gap-3">
                                                <div className="bg-orange-100 text-orange-600 p-2 rounded-lg"><Icon name="clock" /></div>
                                                <div className="text-left">
                                                    <h4 className="font-bold text-slate-800 text-sm">Send Expiry Reminder</h4>
                                                    <p className="text-xs text-slate-500">Urgent action required</p>
                                                </div>
                                            </div>
                                            <Icon name="chevron-right" className="text-slate-300 group-hover:text-orange-500" />
                                        </button>

                                        <button onClick={() => sendMsg('expired')} className="w-full bg-white p-4 rounded-xl border border-red-200 shadow-sm flex items-center justify-between active:scale-[0.98] transition group hover:bg-red-50">
                                            <div className="flex items-center gap-3">
                                                <div className="bg-red-100 text-red-600 p-2 rounded-lg"><Icon name="alert-triangle" /></div>
                                                <div className="text-left">
                                                    <h4 className="font-bold text-slate-800 text-sm">Send Expired Alert</h4>
                                                    <p className="text-xs text-slate-500">Plan has ended</p>
                                                </div>
                                            </div>
                                            <Icon name="chevron-right" className="text-slate-300 group-hover:text-red-500" />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- SUB COMPONENTS ---
        const FilterChip = ({ label, count, active, onClick, color }) => {
            const activeClass = color === 'red' ? 'bg-red-600 text-white shadow-red-200' : 
                                color === 'orange' ? 'bg-orange-500 text-white shadow-orange-200' :
                                color === 'green' ? 'bg-emerald-600 text-white shadow-emerald-200' :
                                'bg-slate-900 text-white shadow-slate-300';
            
            return (
                <button 
                    onClick={onClick}
                    className={`flex items-center gap-2 px-4 py-2.5 rounded-full text-sm font-bold whitespace-nowrap transition-all shadow-sm active:scale-95 ${active ? activeClass : 'bg-white text-slate-500 border border-slate-200'}`}
                >
                    {label} <span className={`text-[10px] px-1.5 py-0.5 rounded-full ${active ? 'bg-white/20' : 'bg-slate-100 text-slate-600'}`}>{count}</span>
                </button>
            );
        };

        // FIXED: Using Solid Colors & White Text for maximum visibility
        const TemplateBtn = ({ title, icon, color, onClick }) => {
            const colors = { 
                blue: 'bg-blue-600 hover:bg-blue-700', 
                purple: 'bg-purple-600 hover:bg-purple-700', 
                green: 'bg-emerald-600 hover:bg-emerald-700', 
                cyan: 'bg-cyan-600 hover:bg-cyan-700' 
            };
            
            return (
                <button onClick={onClick} className={`flex flex-col items-center justify-center gap-2 p-4 rounded-2xl transition active:scale-95 text-white shadow-lg ${colors[color]}`}>
                    <Icon name={icon} size={24} />
                    <span className="text-xs font-bold uppercase tracking-wide">{title}</span>
                </button>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


