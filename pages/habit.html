<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZenTracker Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        primary: '#6366f1', 
                        secondary: '#ec4899', 
                        dark: '#0f172a', 
                        card: '#1e293b',
                        surface: '#f8fafc'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass { background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* Smooth Fade */
        .fade-enter { animation: fadein 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadein { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar for Heatmap */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Button Press Effect */
        .btn-press:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-surface text-gray-800 dark:bg-dark dark:text-gray-100 transition-colors duration-300 min-h-screen pb-28">

    <!-- Navbar -->
    <nav class="fixed top-0 w-full z-30 glass px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-xl bg-gradient-to-tr from-primary to-secondary flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                <i class="fa-solid fa-chart-simple"></i>
            </div>
            <h1 class="text-lg font-bold tracking-tight">ZenTracker <span class="text-[10px] uppercase bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded-md text-gray-500 font-semibold tracking-wider ml-1">PRO</span></h1>
        </div>
        <button onclick="toggleTheme()" class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-600 dark:text-gray-300 transition hover:bg-gray-200 dark:hover:bg-gray-700">
            <i class="fa-solid fa-moon dark:hidden"></i>
            <i class="fa-solid fa-sun hidden dark:inline text-yellow-400"></i>
        </button>
    </nav>

    <!-- VIEW: HOME -->
    <section id="view-home" class="max-w-md mx-auto px-4 pt-20 fade-enter">
        
        <!-- Date Header Card -->
        <div class="bg-white dark:bg-card p-4 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-800 mb-6 flex flex-col items-center justify-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary to-secondary"></div>
            
            <div class="flex w-full justify-between items-center relative z-10">
                <button onclick="changeDate(-1)" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition btn-press">
                    <i class="fa-solid fa-chevron-left text-gray-400"></i>
                </button>
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white" id="currentDateDisplay">Today</h2>
                    <p class="text-xs font-medium text-primary uppercase tracking-widest mt-1" id="currentFullDate">Loading...</p>
                </div>
                <button onclick="changeDate(1)" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition btn-press">
                    <i class="fa-solid fa-chevron-right text-gray-400"></i>
                </button>
            </div>
        </div>

        <!-- Progress Bar (Daily) -->
        <div class="mb-6 px-2">
            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-2 font-medium">
                <span>Daily Progress</span>
                <span id="progressText">0%</span>
            </div>
            <div class="h-3 w-full bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                <div id="dailyProgressBar" class="h-full bg-gradient-to-r from-primary to-secondary transition-all duration-700 ease-out" style="width: 0%"></div>
            </div>
        </div>

        <!-- Habits List -->
        <div id="loadingState" class="flex flex-col items-center py-12">
            <div class="w-10 h-10 border-4 border-primary/30 border-t-primary rounded-full animate-spin mb-4"></div>
            <p class="text-xs font-medium text-gray-400 animate-pulse">SYNCING DATA...</p>
        </div>
        
        <div id="habitsList" class="space-y-3 pb-4"></div>

        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-12 text-center">
            <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4 text-3xl">ðŸŒ±</div>
            <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-1">Start Small</h3>
            <p class="text-sm text-gray-400 max-w-[200px]">Add your first habit to begin your journey.</p>
        </div>
    </section>

    <!-- VIEW: ANALYTICS (New Advanced Dashboard) -->
    <section id="view-analytics" class="max-w-md mx-auto px-4 pt-20 hidden fade-enter">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            Overview <span class="text-xs font-normal text-gray-500 bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded-lg">Last 30 Days</span>
        </h2>

        <!-- 1. Key Metrics Grid -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <!-- Total Ticks Card -->
            <div class="bg-white dark:bg-card p-4 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-800 relative overflow-hidden group">
                <div class="absolute -right-4 -top-4 w-16 h-16 bg-green-500/10 rounded-full blur-xl group-hover:bg-green-500/20 transition"></div>
                <div class="flex flex-col h-full justify-between">
                    <div class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400 mb-2">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-gray-800 dark:text-white" id="stat-total-done">0</div>
                        <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Total Completed</div>
                    </div>
                </div>
            </div>

            <!-- Streak Card -->
            <div class="bg-white dark:bg-card p-4 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-800 relative overflow-hidden group">
                <div class="absolute -right-4 -top-4 w-16 h-16 bg-orange-500/10 rounded-full blur-xl group-hover:bg-orange-500/20 transition"></div>
                <div class="flex flex-col h-full justify-between">
                    <div class="w-8 h-8 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center text-orange-600 dark:text-orange-400 mb-2">
                        <i class="fa-solid fa-fire"></i>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-gray-800 dark:text-white flex items-baseline gap-1">
                            <span id="stat-best-streak">0</span> <span class="text-sm font-normal text-gray-400">days</span>
                        </div>
                        <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Best Streak</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Main Chart: Activity Trend (Line Chart) -->
        <div class="bg-white dark:bg-card p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-800 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-700 dark:text-gray-200 text-sm">Activity Trend</h3>
                <span class="text-[10px] bg-primary/10 text-primary px-2 py-1 rounded-full font-bold">7 DAYS</span>
            </div>
            <!-- Fixed Height Container for Chart -->
            <div class="relative h-48 w-full">
                <canvas id="weeklyChart"></canvas>
            </div>
        </div>

        <!-- 3. Category Split (Doughnut) & Info -->
        <div class="grid grid-cols-5 gap-4 mb-6">
            <div class="col-span-2 bg-white dark:bg-card p-4 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-800 flex flex-col items-center justify-center">
                <div class="relative w-24 h-24">
                    <canvas id="categoryChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-400 pointer-events-none">FOCUS</div>
                </div>
            </div>
            <div class="col-span-3 bg-white dark:bg-card p-4 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-800 flex flex-col justify-center space-y-3">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Distribution</h4>
                <div class="flex items-center justify-between text-xs">
                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-400"></span> Health</div>
                    <span class="font-bold" id="cat-health-pct">0%</span>
                </div>
                <div class="flex items-center justify-between text-xs">
                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-400"></span> Study</div>
                    <span class="font-bold" id="cat-study-pct">0%</span>
                </div>
                <div class="flex items-center justify-between text-xs">
                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-purple-400"></span> Work</div>
                    <span class="font-bold" id="cat-work-pct">0%</span>
                </div>
            </div>
        </div>

        <!-- 4. Consistency Heatmap (Calendar Style) -->
        <div class="bg-white dark:bg-card p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-800 mb-20">
            <h3 class="font-bold text-gray-700 dark:text-gray-200 text-sm mb-4">Consistency Heatmap</h3>
            <div class="overflow-x-auto hide-scroll pb-2">
                <div id="yearHeatmap" class="flex gap-1 min-w-max">
                    <!-- Javascript will generate columns of boxes here -->
                </div>
            </div>
            <div class="flex justify-between items-center mt-3">
                <span class="text-[10px] text-gray-400">Less</span>
                <div class="flex gap-1">
                    <div class="w-2 h-2 rounded-sm bg-gray-100 dark:bg-gray-700"></div>
                    <div class="w-2 h-2 rounded-sm bg-indigo-200"></div>
                    <div class="w-2 h-2 rounded-sm bg-indigo-400"></div>
                    <div class="w-2 h-2 rounded-sm bg-indigo-600"></div>
                </div>
                <span class="text-[10px] text-gray-400">More</span>
            </div>
        </div>

    </section>

    <!-- Bottom Nav -->
    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/90 dark:bg-card/90 backdrop-blur-md border border-gray-200 dark:border-gray-700 rounded-full px-6 py-3 shadow-2xl z-40 flex items-center gap-8">
        <button onclick="switchTab('home')" class="nav-btn text-primary text-xl relative group" id="btn-home">
            <i class="fa-solid fa-list-check transition group-active:scale-90"></i>
            <span class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-1 h-1 bg-primary rounded-full"></span>
        </button>
        
        <button onclick="document.getElementById('addModal').classList.remove('hidden')" class="w-12 h-12 bg-gradient-to-tr from-primary to-secondary rounded-full text-white shadow-lg shadow-indigo-500/40 flex items-center justify-center text-xl transform transition hover:scale-110 active:scale-95 -mt-6 border-4 border-surface dark:border-dark">
            <i class="fa-solid fa-plus"></i>
        </button>

        <button onclick="switchTab('analytics')" class="nav-btn text-gray-400 text-xl relative group" id="btn-analytics">
            <i class="fa-solid fa-chart-pie transition group-active:scale-90"></i>
            <span class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-1 h-1 bg-transparent rounded-full" id="dot-analytics"></span>
        </button>
    </div>

    <!-- Add Modal -->
    <div id="addModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center">
        <div class="bg-white dark:bg-card w-full sm:max-w-sm sm:rounded-3xl rounded-t-3xl p-6 shadow-2xl animate-[slideUp_0.3s_ease-out]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">New Habit</h2>
                <button onclick="document.getElementById('addModal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="addForm">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block">Name</label>
                <input type="text" id="newHabitName" placeholder="e.g. Read 10 mins" class="w-full mb-6 p-4 rounded-2xl bg-gray-50 dark:bg-gray-900 border-none outline-none focus:ring-2 focus:ring-primary/50 font-medium placeholder-gray-400">
                
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block">Category</label>
                <div class="grid grid-cols-3 gap-3 mb-8">
                    <div onclick="selectCat('Health')" class="cat-opt p-3 rounded-2xl border-2 border-transparent bg-gray-50 dark:bg-gray-900 text-center cursor-pointer transition active:scale-95" data-val="Health">
                        <div class="text-xl mb-1">ðŸ’ª</div>
                        <div class="text-[10px] font-bold text-gray-500">Health</div>
                    </div>
                    <div onclick="selectCat('Study')" class="cat-opt p-3 rounded-2xl border-2 border-transparent bg-gray-50 dark:bg-gray-900 text-center cursor-pointer transition active:scale-95" data-val="Study">
                        <div class="text-xl mb-1">ðŸ“š</div>
                        <div class="text-[10px] font-bold text-gray-500">Study</div>
                    </div>
                    <div onclick="selectCat('Work')" class="cat-opt p-3 rounded-2xl border-2 border-transparent bg-gray-50 dark:bg-gray-900 text-center cursor-pointer transition active:scale-95" data-val="Work">
                        <div class="text-xl mb-1">ðŸ’¼</div>
                        <div class="text-[10px] font-bold text-gray-500">Work</div>
                    </div>
                </div>
                <input type="hidden" id="selectedCat" value="Health">
                
                <button type="submit" class="w-full py-4 bg-primary text-white rounded-2xl font-bold shadow-lg shadow-indigo-500/30 active:scale-95 transition">Create Habit</button>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-dark/90 text-white px-6 py-3 rounded-full text-sm font-medium shadow-2xl opacity-0 pointer-events-none transition-all duration-300 z-[60] flex items-center gap-2 translate-y-[-20px]">
        <i class="fa-solid fa-circle-check text-green-400"></i> <span id="toastMsg">Saved</span>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION (YOUR URL GOES HERE)
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzEDgWUSjM4f21pK6ISr3jFLGZSwOVwCz1fnMOcPQ57rKwl09RU-ZYFyNKC1y8NVuTT-g/exec";
        
        let habits = [];
        let logs = [];
        let selectedDate = new Date();
        let weeklyChart = null;
        let categoryChart = null;
        let processingIds = new Set();
        let isDarkMode = localStorage.getItem('theme') === 'dark';

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            if(isDarkMode) document.documentElement.classList.add('dark');
            selectCat('Health'); // Default selection visual
            updateDateDisplay();
            fetchData();
        });

        // --- CORE FUNCTIONS ---
        
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.documentElement.classList.toggle('dark', isDarkMode);
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            if(weeklyChart) updateDashboard(); // Redraw for colors
        }

        function switchTab(tab) {
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-analytics').classList.add('hidden');
            document.getElementById('view-' + tab).classList.remove('hidden');
            
            // Nav Styling
            const homeBtn = document.getElementById('btn-home');
            const anaBtn = document.getElementById('btn-analytics');
            
            if(tab === 'home') {
                homeBtn.classList.replace('text-gray-400', 'text-primary');
                homeBtn.querySelector('span').classList.remove('bg-transparent');
                homeBtn.querySelector('span').classList.add('bg-primary');
                anaBtn.classList.replace('text-primary', 'text-gray-400');
                anaBtn.querySelector('span').classList.remove('bg-primary');
                anaBtn.querySelector('span').classList.add('bg-transparent');
            } else {
                anaBtn.classList.replace('text-gray-400', 'text-primary');
                anaBtn.querySelector('span').classList.remove('bg-transparent');
                anaBtn.querySelector('span').classList.add('bg-primary');
                homeBtn.classList.replace('text-primary', 'text-gray-400');
                homeBtn.querySelector('span').classList.remove('bg-primary');
                homeBtn.querySelector('span').classList.add('bg-transparent');
                
                // CRITICAL: Render charts only when tab is visible
                setTimeout(updateDashboard, 50);
            }
        }

        const getLocalDateStr = (d) => {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        function updateDateDisplay() {
            const today = new Date();
            const isToday = getLocalDateStr(selectedDate) === getLocalDateStr(today);
            
            document.getElementById('currentDateDisplay').innerText = isToday ? "Today" : selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
            document.getElementById('currentFullDate').innerText = selectedDate.toLocaleDateString('en-US', { day: 'numeric', month: 'long' });
            
            renderHabits();
        }

        function changeDate(d) {
            selectedDate.setDate(selectedDate.getDate() + d);
            updateDateDisplay();
        }

        // --- API & DATA ---

        async function fetchData() {
            try {
                const res = await fetch(`${API_URL}?op=get_data`);
                const data = await res.json();
                if(data.status === 'success') {
                    habits = data.habits;
                    logs = data.logs;
                    renderHabits();
                    document.getElementById('loadingState').classList.add('hidden');
                }
            } catch(e) { console.error(e); }
        }

        function renderHabits() {
            const list = document.getElementById('habitsList');
            list.innerHTML = '';
            const dateStr = getLocalDateStr(selectedDate);
            let doneCount = 0;
            
            if(habits.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('dailyProgressBar').style.width = '0%';
                document.getElementById('progressText').innerText = '0%';
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            habits.forEach(h => {
                const isDone = logs.some(l => String(l.habit_id) === String(h.id) && String(l.date) === dateStr);
                const isProcessing = processingIds.has(h.id);
                if(isDone) doneCount++;

                const div = document.createElement('div');
                div.className = `p-4 rounded-3xl flex items-center justify-between transition-all duration-300 border btn-press select-none ${isDone ? 'bg-indigo-50 border-indigo-200 dark:bg-indigo-900/20 dark:border-indigo-800/50' : 'bg-white border-transparent dark:bg-card dark:border-transparent shadow-sm'}`;
                
                div.onclick = (e) => {
                    // Prevent clicking delete btn from triggering toggle
                    if(e.target.closest('.delete-btn')) return;
                    toggleLog(h.id);
                };

                div.innerHTML = `
                    <div class="flex items-center gap-4 flex-1">
                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl ${getIconBg(h.category)} transition-colors">
                            ${getIcon(h.category)}
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 dark:text-gray-100 ${isDone ? 'line-through opacity-50' : ''}">${h.name}</h3>
                            <p class="text-[10px] font-bold uppercase tracking-wider text-gray-400 mt-0.5">${h.category}</p>
                        </div>
                    </div>
                    <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all duration-300 ${isProcessing ? 'opacity-50' : ''} ${isDone ? 'bg-primary border-primary text-white scale-110 shadow-lg shadow-primary/30' : 'border-gray-200 dark:border-gray-700 text-transparent'}">
                        ${isProcessing ? '<i class="fa-solid fa-circle-notch fa-spin text-xs"></i>' : '<i class="fa-solid fa-check text-xs"></i>'}
                    </div>
                `;
                
                // Add delete option on long press could be added here, but keeping simple
                list.appendChild(div);
            });

            // Update Progress Bar
            const percent = Math.round((doneCount / habits.length) * 100);
            document.getElementById('dailyProgressBar').style.width = `${percent}%`;
            document.getElementById('progressText').innerText = `${doneCount}/${habits.length}`;
        }

        function getIcon(cat) {
            if(cat === 'Health') return 'âš¡'; 
            if(cat === 'Study') return 'ðŸ§ '; 
            if(cat === 'Work') return 'ðŸš€'; 
            return 'âœ¨';
        }
        function getIconBg(cat) {
            if(cat === 'Health') return 'bg-emerald-100 text-emerald-600 dark:bg-emerald-500/20 dark:text-emerald-400';
            if(cat === 'Study') return 'bg-blue-100 text-blue-600 dark:bg-blue-500/20 dark:text-blue-400';
            if(cat === 'Work') return 'bg-purple-100 text-purple-600 dark:bg-purple-500/20 dark:text-purple-400';
            return 'bg-gray-100 text-gray-600';
        }

        async function toggleLog(id) {
            if (processingIds.has(id)) return;
            processingIds.add(id);
            renderHabits(); // Show spinner

            const dateStr = getLocalDateStr(selectedDate);
            const idx = logs.findIndex(l => String(l.habit_id) === String(id) && String(l.date) === dateStr);
            
            if(idx > -1) logs.splice(idx, 1);
            else logs.push({habit_id: id, date: dateStr, status: 'done'});

            try {
                await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({op: 'toggle_log', habit_id: id, date: dateStr})
                });
            } catch(e) {
                showToast("Sync Error", true);
            } finally {
                processingIds.delete(id);
                renderHabits();
                if(idx === -1) showToast("Completed!");
            }
        }

        // --- ADVANCED ANALYTICS ---

        function updateDashboard() {
            document.getElementById('stat-total-done').innerText = logs.length;
            
            // Calc Streak (Simplified best day volume)
            const counts = {};
            logs.forEach(l => { counts[l.date] = (counts[l.date] || 0) + 1; });
            const best = Object.values(counts).length > 0 ? Math.max(...Object.values(counts)) : 0;
            document.getElementById('stat-best-streak').innerText = best; // Using max habits in a day as proxy for demo

            renderWeeklyChart();
            renderCategoryChart();
            renderHeatmap();
        }

        function renderWeeklyChart() {
            const ctx = document.getElementById('weeklyChart');
            if(!ctx) return;
            
            const labels = [], data = [];
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('en-US', {weekday: 'short'}));
                data.push(logs.filter(l => l.date === getLocalDateStr(d)).length);
            }

            if(weeklyChart) weeklyChart.destroy();
            
            // Gradient
            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)'); // Primary color
            gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

            weeklyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Habits',
                        data: data,
                        borderColor: '#6366f1',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#6366f1',
                        pointRadius: 4,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { display: false, beginAtZero: true },
                        x: { grid: { display: false }, ticks: { color: isDarkMode ? '#94a3b8' : '#64748b' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderCategoryChart() {
            const ctx = document.getElementById('categoryChart');
            if(!ctx) return;

            // Calculate distribution based on LOGS (actual performance)
            let health = 0, study = 0, work = 0;
            
            // Map habit IDs to categories
            const habitMap = {};
            habits.forEach(h => habitMap[h.id] = h.category);

            logs.forEach(l => {
                const cat = habitMap[l.habit_id];
                if(cat === 'Health') health++;
                else if(cat === 'Study') study++;
                else if(cat === 'Work') work++;
            });

            const total = health + study + work || 1; // avoid div by zero
            
            // Update Text Percentages
            document.getElementById('cat-health-pct').innerText = Math.round((health/total)*100) + '%';
            document.getElementById('cat-study-pct').innerText = Math.round((study/total)*100) + '%';
            document.getElementById('cat-work-pct').innerText = Math.round((work/total)*100) + '%';

            if(categoryChart) categoryChart.destroy();

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Health', 'Study', 'Work'],
                    datasets: [{
                        data: [health, study, work],
                        backgroundColor: ['#34d399', '#60a5fa', '#c084fc'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '75%',
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderHeatmap() {
            const container = document.getElementById('yearHeatmap');
            container.innerHTML = '';
            
            const countMap = {};
            logs.forEach(l => countMap[l.date] = (countMap[l.date] || 0) + 1);

            // Generate last 14 weeks (approx 3 months) for horizontal scroll
            // Grid flow: column by column (Weeks)
            for(let w=0; w<15; w++) {
                const col = document.createElement('div');
                col.className = 'flex flex-col gap-1';
                
                for(let d=0; d<7; d++) {
                    const date = new Date();
                    // Calculate date backwards: (15 weeks * 7) - (current col * 7 + day)
                    const daysAgo = (14 - w) * 7 + (6 - d); 
                    date.setDate(date.getDate() - daysAgo);
                    
                    const iso = getLocalDateStr(date);
                    const count = countMap[iso] || 0;
                    
                    const cell = document.createElement('div');
                    // Style logic
                    let colorClass = isDarkMode ? 'bg-gray-800' : 'bg-gray-100';
                    if(count > 0) colorClass = 'bg-indigo-200';
                    if(count > 2) colorClass = 'bg-indigo-400';
                    if(count > 4) colorClass = 'bg-indigo-600';
                    
                    cell.className = `w-3 h-3 rounded-sm ${colorClass}`;
                    cell.title = `${iso}: ${count}`;
                    col.appendChild(cell);
                }
                container.appendChild(col);
            }
        }

        // --- ACTIONS ---
        function selectCat(cat) {
            document.getElementById('selectedCat').value = cat;
            document.querySelectorAll('.cat-opt').forEach(el => {
                el.classList.remove('ring-2', 'ring-primary', 'bg-indigo-50', 'dark:bg-indigo-900/20');
                el.classList.add('bg-gray-50', 'dark:bg-gray-900');
            });
            const activeEl = document.querySelector(`.cat-opt[data-val="${cat}"]`);
            activeEl.classList.remove('bg-gray-50', 'dark:bg-gray-900');
            activeEl.classList.add('ring-2', 'ring-primary', 'bg-indigo-50', 'dark:bg-indigo-900/20');
        }
        
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('newHabitName').value;
            const category = document.getElementById('selectedCat').value;
            if(!name) return;

            // Optimistic Add
            const tempId = 'temp-' + Date.now();
            habits.push({id: tempId, name, category});
            renderHabits();
            document.getElementById('addModal').classList.add('hidden');
            document.getElementById('newHabitName').value = '';
            
            const res = await fetch(API_URL, {
                method: 'POST', body: JSON.stringify({op: 'add_habit', name, category})
            });
            const d = await res.json();
            if(d.status === 'success') {
                // Replace temp ID
                const hIndex = habits.findIndex(h => h.id === tempId);
                if(hIndex > -1) habits[hIndex].id = d.id;
            }
            showToast("Habit Created");
        });

        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.querySelector('i').className = isError ? "fa-solid fa-circle-exclamation text-red-400" : "fa-solid fa-circle-check text-green-400";
            t.classList.remove('translate-y-[-20px]', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-[-20px]', 'opacity-0'), 2500);
        }

    </script>
</body>
</html>
