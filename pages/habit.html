<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zen Habit Tracker Pro + AI</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Markdown Parser (Optional for AI text, but we will use JSON) -->
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1', 
                        secondary: '#ec4899',
                        dark: '#0f172a',
                        card: '#1e293b',
                        ai: '#8b5cf6' // Purple for AI
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 4px; }
        
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .dark .glass {
            background: rgba(15, 23, 42, 0.9);
        }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(53, 1fr); /* Weeks */
            gap: 2px;
        }
        .heatmap-cell {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 2px;
        }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Sparkle Animation for AI */
        @keyframes sparkle {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        .sparkle-anim { animation: sparkle 2s infinite; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-dark dark:text-gray-100 transition-colors duration-300 min-h-screen pb-24">

    <!-- Top Bar -->
    <nav class="fixed top-0 w-full z-20 glass border-b border-gray-200 dark:border-gray-800 px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <div class="bg-gradient-to-tr from-primary to-secondary text-white p-1.5 rounded-lg">
                <i class="fa-solid fa-chart-line"></i>
            </div>
            <h1 class="text-lg font-bold">ZenTracker <span class="text-xs text-white bg-gradient-to-r from-purple-500 to-pink-500 px-1.5 py-0.5 rounded ml-1">AI</span></h1>
        </div>
        <button onclick="toggleTheme()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
            <i class="fa-solid fa-moon dark:hidden text-gray-600"></i>
            <i class="fa-solid fa-sun hidden dark:inline text-yellow-400"></i>
        </button>
    </nav>

    <!-- VIEW: HOME (Habit List) -->
    <section id="view-home" class="max-w-md mx-auto px-4 pt-20 fade-in">
        
        <!-- AI Suggestion Banner -->
        <div class="bg-gradient-to-r from-violet-600 to-indigo-600 rounded-2xl p-4 text-white shadow-lg mb-6 flex items-center justify-between cursor-pointer transform transition hover:scale-[1.02]" onclick="openAIModal()">
            <div>
                <h3 class="font-bold flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles text-yellow-300 sparkle-anim"></i> AI Coach</h3>
                <p class="text-xs text-indigo-100 mt-1">Stuck? Get a personalized plan.</p>
            </div>
            <div class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center">
                <i class="fa-solid fa-chevron-right text-xs"></i>
            </div>
        </div>

        <!-- Date Header -->
        <div class="flex justify-between items-center mb-6 bg-white dark:bg-card p-3 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800">
            <button onclick="changeDate(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i class="fa-solid fa-chevron-left"></i></button>
            <div class="text-center">
                <h2 class="text-sm font-bold uppercase tracking-wide text-primary" id="currentDateDisplay">Today</h2>
                <p class="text-xs text-gray-400" id="currentFullDate">Loading...</p>
            </div>
            <button onclick="changeDate(1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i class="fa-solid fa-chevron-right"></i></button>
        </div>

        <!-- Habits List -->
        <div id="loadingState" class="text-center py-10">
            <div class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
            <p class="text-xs text-gray-400">Syncing with Cloud...</p>
        </div>
        
        <div id="habitsList" class="space-y-3 pb-20"></div>

        <div id="emptyState" class="hidden text-center py-10">
            <i class="fa-solid fa-wind text-4xl text-gray-300 mb-2"></i>
            <p class="text-sm text-gray-400">No habits yet. Use AI Coach to start!</p>
        </div>
    </section>

    <!-- VIEW: ANALYTICS (Dashboard) -->
    <section id="view-analytics" class="max-w-md mx-auto px-4 pt-20 hidden fade-in">
        <!-- Summary Cards -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-white dark:bg-card p-4 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm">
                <div class="text-xs text-gray-500 mb-1">Total Completion</div>
                <div class="text-2xl font-bold text-green-500" id="stat-total-done">0</div>
            </div>
            <div class="bg-white dark:bg-card p-4 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm">
                <div class="text-xs text-gray-500 mb-1">Best Streak</div>
                <div class="text-2xl font-bold text-orange-500 flex items-center gap-1">
                    <span id="stat-best-streak">0</span> <i class="fa-solid fa-fire text-sm"></i>
                </div>
            </div>
        </div>
        <!-- Weekly Graph -->
        <div class="bg-white dark:bg-card p-4 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm mb-6">
            <h3 class="text-sm font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-chart-bar text-primary"></i> Last 7 Days</h3>
            <canvas id="weeklyChart" height="200"></canvas>
        </div>
        <!-- Yearly Heatmap -->
        <div class="bg-white dark:bg-card p-4 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm mb-6 overflow-hidden">
            <h3 class="text-sm font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-th text-primary"></i> Yearly Consistency</h3>
            <div class="overflow-x-auto">
                <div id="yearHeatmap" class="heatmap-grid min-w-[300px]"></div>
            </div>
        </div>
    </section>

    <!-- Bottom Navigation -->
    <div class="fixed bottom-0 w-full bg-white dark:bg-card border-t border-gray-200 dark:border-gray-800 pb-safe z-30">
        <div class="flex justify-around items-center max-w-md mx-auto">
            <button onclick="switchTab('home')" class="nav-btn active flex-1 py-3 text-center text-gray-400 hover:text-primary transition" id="btn-home">
                <i class="fa-solid fa-list-check text-xl mb-1 block"></i>
                <span class="text-[10px] font-medium">Journal</span>
            </button>
            
            <div class="relative -top-5">
                <button onclick="openAddModal()" class="w-14 h-14 bg-gradient-to-r from-primary to-secondary rounded-full text-white shadow-lg shadow-indigo-500/40 flex items-center justify-center text-2xl transform active:scale-95 transition">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <button onclick="switchTab('analytics')" class="nav-btn flex-1 py-3 text-center text-gray-400 hover:text-primary transition" id="btn-analytics">
                <i class="fa-solid fa-chart-pie text-xl mb-1 block"></i>
                <span class="text-[10px] font-medium">Insights</span>
            </button>
        </div>
    </div>

    <!-- AI MODAL -->
    <div id="aiModal" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-50 flex items-center justify-center px-4">
        <div class="bg-white dark:bg-card w-full max-w-sm p-6 rounded-3xl shadow-2xl border border-white/10 relative overflow-hidden">
            <!-- Decorative Glow -->
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-purple-500/20 rounded-full blur-3xl"></div>
            
            <div class="relative z-10">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold flex items-center gap-2 bg-clip-text text-transparent bg-gradient-to-r from-purple-500 to-pink-500">
                        <i class="fa-solid fa-robot text-purple-500"></i> AI Habit Coach
                    </h2>
                    <button onclick="closeAIModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>

                <div class="mb-4">
                    <label class="block text-xs text-gray-500 dark:text-gray-400 mb-2">What is your goal?</label>
                    <div class="flex gap-2">
                        <input type="text" id="aiPrompt" placeholder="e.g. I want to learn Spanish..." 
                            class="flex-1 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                        <button onclick="askGemini()" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-xl transition shadow-lg shadow-purple-500/25">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2"><i class="fa-solid fa-info-circle"></i> Gemini will suggest 3 daily habits.</p>
                </div>

                <!-- AI Results Area -->
                <div id="aiLoading" class="hidden text-center py-8">
                    <div class="w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                    <p class="text-xs text-purple-400 animate-pulse">Thinking...</p>
                </div>

                <div id="aiResults" class="space-y-3 max-h-[40vh] overflow-y-auto hidden">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>
    </div>

    <!-- HABIT DETAIL MODAL (Individual Dashboard) -->
    <div id="detailModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center">
        <div class="bg-gray-50 dark:bg-dark w-full max-w-md h-[85vh] sm:h-auto sm:rounded-2xl rounded-t-3xl overflow-hidden flex flex-col shadow-2xl transform transition-transform translate-y-full" id="detailModalContent">
            <!-- Header -->
            <div class="p-4 bg-white dark:bg-card border-b border-gray-200 dark:border-gray-800 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold" id="detailName">Habit Name</h2>
                    <span class="text-xs px-2 py-0.5 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300" id="detailCat">Category</span>
                </div>
                <button onclick="closeDetailModal()" class="w-8 h-8 bg-gray-100 dark:bg-gray-700 rounded-full"><i class="fa-solid fa-times"></i></button>
            </div>
            <!-- Content -->
            <div class="p-4 overflow-y-auto flex-1 space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white dark:bg-card p-4 rounded-xl border border-gray-100 dark:border-gray-700 text-center">
                        <div class="text-3xl font-bold text-primary mb-1" id="detailTotal">0</div>
                        <div class="text-xs text-gray-500">Times Completed</div>
                    </div>
                    <div class="bg-white dark:bg-card p-4 rounded-xl border border-gray-100 dark:border-gray-700 text-center">
                        <div class="text-3xl font-bold text-orange-500 mb-1" id="detailStreak">0</div>
                        <div class="text-xs text-gray-500">Current Streak</div>
                    </div>
                </div>
                <div class="bg-white dark:bg-card p-4 rounded-xl border border-gray-100 dark:border-gray-700">
                    <h3 class="text-sm font-bold mb-3">This Month</h3>
                    <div class="grid grid-cols-7 gap-1 text-center text-xs mb-2 text-gray-400">
                        <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center text-sm" id="detailCalendar"></div>
                </div>
                <button id="deleteHabitBtn" class="w-full py-3 text-red-500 bg-red-50 dark:bg-red-900/20 rounded-xl font-medium text-sm mt-4">
                    <i class="fa-solid fa-trash mr-2"></i> Delete Habit
                </button>
            </div>
        </div>
    </div>

    <!-- ADD MODAL (Simplified) -->
    <div id="addModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center px-4">
        <div class="bg-white dark:bg-card w-full max-w-sm p-6 rounded-2xl shadow-xl">
            <h2 class="text-lg font-bold mb-4">New Habit</h2>
            <form id="addForm">
                <input type="text" id="newHabitName" placeholder="e.g., Read 10 pages" class="w-full mb-4 p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border-none outline-none focus:ring-2 focus:ring-primary">
                
                <div class="grid grid-cols-3 gap-2 mb-6">
                    <div onclick="selectCat('Health')" class="cat-opt p-2 rounded-lg border dark:border-gray-600 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700" data-val="Health">ðŸ’ª</div>
                    <div onclick="selectCat('Study')" class="cat-opt p-2 rounded-lg border dark:border-gray-600 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700" data-val="Study">ðŸ“š</div>
                    <div onclick="selectCat('Work')" class="cat-opt p-2 rounded-lg border dark:border-gray-600 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700" data-val="Work">ðŸ’¼</div>
                </div>
                <input type="hidden" id="selectedCat" value="Health">
                
                <div class="flex gap-3">
                    <button type="button" onclick="document.getElementById('addModal').classList.add('hidden')" class="flex-1 py-2 text-gray-500">Cancel</button>
                    <button type="submit" class="flex-1 py-2 bg-primary text-white rounded-xl shadow-lg shadow-indigo-500/30">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-full text-sm opacity-0 pointer-events-none transition-opacity duration-300 z-[60]">
        Action Saved
    </div>

    <script>
        // ==========================================
        // CONFIGURATION (PASTE YOUR URL HERE)
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzEDgWUSjM4f21pK6ISr3jFLGZSwOVwCz1fnMOcPQ57rKwl09RU-ZYFyNKC1y8NVuTT-g/exec"; 
        
        // GEMINI API KEY (Runtime provided)
        const apiKey = ""; 

        let habits = [];
        let logs = [];
        let selectedDate = new Date();
        let chartInstance = null;
        let isDarkMode = localStorage.getItem('theme') === 'dark';

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            if(isDarkMode) document.documentElement.classList.add('dark');
            updateDateDisplay();
            fetchData();
        });

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.documentElement.classList.toggle('dark', isDarkMode);
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            if(chartInstance) updateDashboard(); 
        }

        // --- GEMINI AI LOGIC ---
        function openAIModal() {
            document.getElementById('aiModal').classList.remove('hidden');
            document.getElementById('aiPrompt').focus();
        }
        function closeAIModal() {
            document.getElementById('aiModal').classList.add('hidden');
            document.getElementById('aiResults').innerHTML = '';
            document.getElementById('aiResults').classList.add('hidden');
        }

        async function askGemini() {
            const prompt = document.getElementById('aiPrompt').value;
            if(!prompt) return;

            const loading = document.getElementById('aiLoading');
            const resultsDiv = document.getElementById('aiResults');
            
            loading.classList.remove('hidden');
            resultsDiv.classList.add('hidden');
            resultsDiv.innerHTML = '';

            try {
                const systemPrompt = "You are a friendly Habit Coach. The user will give you a goal. You must suggest 3 specific, small, daily trackable habits to help them achieve it. Return ONLY valid JSON array with objects containing 'name' (max 4 words), 'category' (Health, Study, or Work), and 'emoji'. Example: [{'name': 'Drink water', 'category': 'Health', 'emoji': 'ðŸ’§'}]. No markdown formatting.";
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }]},
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;
                const suggestions = JSON.parse(aiText);

                renderAISuggestions(suggestions);

            } catch (error) {
                console.error(error);
                resultsDiv.innerHTML = `<div class="text-red-400 text-center text-sm">Oops! AI is tired. Try again.</div>`;
                resultsDiv.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        function renderAISuggestions(list) {
            const container = document.getElementById('aiResults');
            container.classList.remove('hidden');
            
            list.forEach(item => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-gray-50 dark:bg-white/5 p-3 rounded-xl border border-gray-100 dark:border-white/10";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${item.emoji}</span>
                        <div>
                            <h4 class="font-bold text-sm dark:text-gray-200">${item.name}</h4>
                            <span class="text-[10px] uppercase tracking-wider text-gray-400">${item.category}</span>
                        </div>
                    </div>
                    <button onclick="addAIHabit('${item.name}', '${item.category}')" class="bg-purple-600 hover:bg-purple-700 text-white w-8 h-8 rounded-full flex items-center justify-center transition">
                        <i class="fa-solid fa-plus text-xs"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        async function addAIHabit(name, category) {
            // Reusing existing add logic but from AI context
            showToast(`Adding ${name}...`);
            
            // Call API
            const res = await fetch(API_URL, {
                method: 'POST', body: JSON.stringify({op: 'add_habit', name, category})
            });
            const d = await res.json();
            
            if(d.status === 'success') {
                habits.push({id: d.id, name, category});
                renderHabits();
                showToast("Habit added successfully!");
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 2000);
        }

        // --- NAVIGATION ---
        function switchTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('text-primary'));
            document.getElementById('btn-' + tab).classList.add('text-primary');
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-analytics').classList.add('hidden');
            document.getElementById('view-' + tab).classList.remove('hidden');
            if(tab === 'analytics') updateDashboard();
        }

        // --- DATE LOGIC ---
        function updateDateDisplay() {
            const today = new Date();
            const isToday = selectedDate.toDateString() === today.toDateString();
            document.getElementById('currentDateDisplay').innerText = isToday ? "Today" : selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
            document.getElementById('currentFullDate').innerText = selectedDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
            renderHabits();
        }
        function changeDate(d) {
            selectedDate.setDate(selectedDate.getDate() + d);
            updateDateDisplay();
        }
        const getISODate = (d) => {
            const z = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
            return z.toISOString().split('T')[0];
        };

        // --- DATA & API ---
        async function fetchData() {
            try {
                const res = await fetch(`${API_URL}?op=get_data`);
                const data = await res.json();
                if(data.status === 'success') {
                    habits = data.habits;
                    logs = data.logs;
                    renderHabits();
                    document.getElementById('loadingState').classList.add('hidden');
                }
            } catch(e) { console.error(e); }
        }

        // --- HOME VIEW RENDER ---
        function renderHabits() {
            const list = document.getElementById('habitsList');
            list.innerHTML = '';
            const dateStr = getISODate(selectedDate);
            
            if(habits.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            habits.forEach(h => {
                const isDone = logs.some(l => l.habit_id == h.id && l.date == dateStr);
                
                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl flex items-center justify-between transition-all border ${isDone ? 'bg-indigo-50 border-indigo-200 dark:bg-indigo-900/10 dark:border-indigo-800' : 'bg-white border-gray-100 dark:bg-card dark:border-gray-800'}`;
                
                div.innerHTML = `
                    <div class="flex items-center gap-4 flex-1" onclick="openHabitDetail('${h.id}')">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl bg-gray-100 dark:bg-gray-700">
                            ${getIcon(h.category)}
                        </div>
                        <div>
                            <h3 class="font-bold ${isDone ? 'line-through text-gray-400' : ''}">${h.name}</h3>
                            <p class="text-xs text-gray-400">${h.category}</p>
                        </div>
                    </div>
                    <button onclick="toggleLog('${h.id}')" class="w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${isDone ? 'bg-primary border-primary text-white scale-110' : 'border-gray-300 text-transparent'}">
                        <i class="fa-solid fa-check text-xs"></i>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function getIcon(cat) {
            if(cat === 'Health') return 'ðŸ’ª';
            if(cat === 'Study') return 'ðŸ“š';
            if(cat === 'Work') return 'ðŸ’¼';
            return 'âœ¨';
        }

        async function toggleLog(id) {
            const dateStr = getISODate(selectedDate);
            const idx = logs.findIndex(l => l.habit_id == id && l.date == dateStr);
            if(idx > -1) logs.splice(idx, 1);
            else logs.push({habit_id: id, date: dateStr, status: 'done'});
            renderHabits();
            await fetch(API_URL, {
                method: 'POST', body: JSON.stringify({op: 'toggle_log', habit_id: id, date: dateStr})
            });
        }

        // --- ANALYTICS & DASHBOARD ---
        function updateDashboard() {
            const totalDone = logs.length;
            document.getElementById('stat-total-done').innerText = totalDone;
            
            const counts = {};
            logs.forEach(l => { counts[l.date] = (counts[l.date] || 0) + 1; });
            const bestDay = Math.max(...Object.values(counts), 0);
            document.getElementById('stat-best-streak').innerText = bestDay;

            renderWeeklyChart();
            renderHeatmap();
        }

        function renderWeeklyChart() {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            const labels = [];
            const data = [];
            for(let i=6; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('en-US', {weekday: 'short'}));
                data.push(logs.filter(l => l.date === getISODate(d)).length);
            }
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Habits Completed',
                        data: data,
                        backgroundColor: '#6366f1',
                        borderRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderHeatmap() {
            const container = document.getElementById('yearHeatmap');
            container.innerHTML = '';
            const countMap = {};
            logs.forEach(l => countMap[l.date] = (countMap[l.date] || 0) + 1);
            for(let i=150; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const iso = getISODate(d);
                const count = countMap[iso] || 0;
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                if(count === 0) cell.style.backgroundColor = isDarkMode ? '#1e293b' : '#f1f5f9';
                else if(count === 1) cell.style.backgroundColor = '#a5b4fc';
                else if(count <= 3) cell.style.backgroundColor = '#6366f1';
                else cell.style.backgroundColor = '#4338ca';
                container.appendChild(cell);
            }
        }

        // --- HABIT DETAIL ---
        function openHabitDetail(id) {
            const habit = habits.find(h => h.id == id);
            if(!habit) return;
            const modal = document.getElementById('detailModalContent');
            document.getElementById('detailModal').classList.remove('hidden');
            setTimeout(() => modal.classList.remove('translate-y-full'), 10);
            document.getElementById('detailName').innerText = habit.name;
            document.getElementById('detailCat').innerText = habit.category;
            const habitLogs = logs.filter(l => l.habit_id == id);
            document.getElementById('detailTotal').innerText = habitLogs.length;
            
            // Streak Logic
            let streak = 0;
            const today = getISODate(new Date());
            if(habitLogs.some(l => l.date === today)) streak++;
            for(let i=1; i<365; i++) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                if(habitLogs.some(l => l.date === getISODate(d))) streak++; else break;
            }
            document.getElementById('detailStreak').innerText = streak;
            renderDetailCalendar(id);
            document.getElementById('deleteHabitBtn').onclick = () => deleteHabit(id);
        }

        function renderDetailCalendar(habitId) {
            const grid = document.getElementById('detailCalendar');
            grid.innerHTML = '';
            const date = new Date();
            const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
            for(let i=1; i<=daysInMonth; i++) {
                const dStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const isDone = logs.some(l => l.habit_id == habitId && l.date == dStr);
                const el = document.createElement('div');
                el.innerText = i;
                el.className = `h-8 w-8 flex items-center justify-center rounded-full text-xs mx-auto ${isDone ? 'bg-green-500 text-white font-bold' : 'text-gray-400'}`;
                grid.appendChild(el);
            }
        }

        function closeDetailModal() {
            document.getElementById('detailModalContent').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('detailModal').classList.add('hidden'), 300);
        }

        // --- ACTIONS ---
        function selectCat(cat) {
            document.getElementById('selectedCat').value = cat;
            document.querySelectorAll('.cat-opt').forEach(el => el.classList.remove('bg-indigo-100', 'border-primary'));
            event.currentTarget.classList.add('bg-indigo-100', 'border-primary');
        }
        
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('newHabitName').value;
            const category = document.getElementById('selectedCat').value;
            const res = await fetch(API_URL, {
                method: 'POST', body: JSON.stringify({op: 'add_habit', name, category})
            });
            const d = await res.json();
            if(d.status === 'success') {
                habits.push({id: d.id, name, category});
                renderHabits();
                document.getElementById('addModal').classList.add('hidden');
            }
        });

        async function deleteHabit(id) {
            if(confirm('Delete this habit?')) {
                habits = habits.filter(h => h.id != id);
                renderHabits();
                closeDetailModal();
                await fetch(API_URL, {method: 'POST', body: JSON.stringify({op: 'delete_habit', habit_id: id})});
            }
        }
        function openAddModal() { document.getElementById('addModal').classList.remove('hidden'); }
    </script>
</body>
</html>
