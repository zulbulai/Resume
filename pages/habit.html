<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zen Habit Tracker AI</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { primary: '#6366f1', secondary: '#ec4899', dark: '#0f172a', card: '#1e293b' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 4px; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .dark .glass { background: rgba(15, 23, 42, 0.95); }
        .heatmap-grid { display: grid; grid-template-columns: repeat(53, 1fr); gap: 2px; }
        .heatmap-cell { width: 100%; aspect-ratio: 1; border-radius: 2px; }
        
        /* Processing Animation (Lock Button) */
        .processing { pointer-events: none; opacity: 0.6; position: relative; }
        
        /* AI Sparkle */
        @keyframes sparkle { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
        .sparkle-anim { animation: sparkle 2s infinite; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-dark dark:text-gray-100 transition-colors duration-300 min-h-screen pb-24">

    <!-- Top Bar -->
    <nav class="fixed top-0 w-full z-20 glass border-b border-gray-200 dark:border-gray-800 px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <div class="bg-gradient-to-tr from-primary to-secondary text-white p-1.5 rounded-lg">
                <i class="fa-solid fa-chart-line"></i>
            </div>
            <h1 class="text-lg font-bold">ZenTracker <span class="text-xs text-white bg-gradient-to-r from-purple-500 to-pink-500 px-1.5 py-0.5 rounded ml-1">AI</span></h1>
        </div>
        <button onclick="toggleTheme()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
            <i class="fa-solid fa-moon dark:hidden text-gray-600"></i>
            <i class="fa-solid fa-sun hidden dark:inline text-yellow-400"></i>
        </button>
    </nav>

    <!-- VIEW: HOME -->
    <section id="view-home" class="max-w-md mx-auto px-4 pt-20 fade-in">
        
        <!-- AI Banner -->
        <div class="bg-gradient-to-r from-violet-600 to-indigo-600 rounded-2xl p-4 text-white shadow-lg mb-6 flex items-center justify-between cursor-pointer transform transition hover:scale-[1.02]" onclick="openAIModal()">
            <div>
                <h3 class="font-bold flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles text-yellow-300 sparkle-anim"></i> AI Coach</h3>
                <p class="text-xs text-indigo-100 mt-1">Stuck? Get a personalized plan.</p>
            </div>
            <div class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center">
                <i class="fa-solid fa-chevron-right text-xs"></i>
            </div>
        </div>

        <!-- Date Header -->
        <div class="flex justify-between items-center mb-6 bg-white dark:bg-card p-3 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800">
            <button onclick="changeDate(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i class="fa-solid fa-chevron-left"></i></button>
            <div class="text-center">
                <h2 class="text-sm font-bold uppercase tracking-wide text-primary" id="currentDateDisplay">Today</h2>
                <p class="text-xs text-gray-400" id="currentFullDate">Loading...</p>
            </div>
            <button onclick="changeDate(1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i class="fa-solid fa-chevron-right"></i></button>
        </div>

        <div id="loadingState" class="text-center py-10">
            <div class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
            <p class="text-xs text-gray-400">Syncing...</p>
        </div>
        
        <div id="habitsList" class="space-y-3 pb-20"></div>

        <div id="emptyState" class="hidden text-center py-10">
            <i class="fa-solid fa-wind text-4xl text-gray-300 mb-2"></i>
            <p class="text-sm text-gray-400">No habits yet. Use AI Coach!</p>
        </div>
    </section>

    <!-- VIEW: ANALYTICS -->
    <section id="view-analytics" class="max-w-md mx-auto px-4 pt-20 hidden fade-in">
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-white dark:bg-card p-4 rounded-2xl border border-gray-100 dark:border-gray-800">
                <div class="text-xs text-gray-500 mb-1">Total Ticks</div>
                <div class="text-2xl font-bold text-green-500" id="stat-total-done">0</div>
            </div>
            <div class="bg-white dark:bg-card p-4 rounded-2xl border border-gray-100 dark:border-gray-800">
                <div class="text-xs text-gray-500 mb-1">Best Streak</div>
                <div class="text-2xl font-bold text-orange-500" id="stat-best-streak">0</div>
            </div>
        </div>
        <div class="bg-white dark:bg-card p-4 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm mb-6">
            <h3 class="text-sm font-bold mb-4">Last 7 Days</h3>
            <canvas id="weeklyChart" height="200"></canvas>
        </div>
         <div class="bg-white dark:bg-card p-4 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm mb-6 overflow-hidden">
            <h3 class="text-sm font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-th text-primary"></i> Consistency</h3>
            <div class="overflow-x-auto">
                <div id="yearHeatmap" class="heatmap-grid min-w-[300px]"></div>
            </div>
        </div>
    </section>

    <!-- Bottom Nav -->
    <div class="fixed bottom-0 w-full bg-white dark:bg-card border-t border-gray-200 dark:border-gray-800 pb-safe z-30">
        <div class="flex justify-around items-center max-w-md mx-auto">
            <button onclick="switchTab('home')" class="nav-btn active flex-1 py-3 text-center text-primary" id="btn-home"><i class="fa-solid fa-list-check text-xl"></i></button>
            <div class="relative -top-5">
                <button onclick="document.getElementById('addModal').classList.remove('hidden')" class="w-14 h-14 bg-gradient-to-r from-primary to-secondary rounded-full text-white shadow-lg flex items-center justify-center text-2xl"><i class="fa-solid fa-plus"></i></button>
            </div>
            <button onclick="switchTab('analytics')" class="nav-btn flex-1 py-3 text-center text-gray-400" id="btn-analytics"><i class="fa-solid fa-chart-pie text-xl"></i></button>
        </div>
    </div>

    <!-- AI MODAL -->
    <div id="aiModal" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-50 flex items-center justify-center px-4">
        <div class="bg-white dark:bg-card w-full max-w-sm p-6 rounded-3xl shadow-2xl border border-white/10 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-purple-500/20 rounded-full blur-3xl"></div>
            <div class="relative z-10">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold flex items-center gap-2 bg-clip-text text-transparent bg-gradient-to-r from-purple-500 to-pink-500"><i class="fa-solid fa-robot text-purple-500"></i> AI Habit Coach</h2>
                    <button onclick="closeAIModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="mb-4">
                    <input type="text" id="aiPrompt" placeholder="What is your goal? (e.g. Learn Python)" class="w-full bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none mb-2">
                    <button onclick="askGemini()" class="w-full bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-xl transition shadow-lg">Ask AI to Plan</button>
                </div>
                <div id="aiLoading" class="hidden text-center py-4"><div class="w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto"></div></div>
                <div id="aiResults" class="space-y-3 max-h-[40vh] overflow-y-auto hidden"></div>
            </div>
        </div>
    </div>

    <!-- Add Modal -->
    <div id="addModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center px-4">
        <div class="bg-white dark:bg-card w-full max-w-sm p-6 rounded-2xl shadow-xl">
            <h2 class="text-lg font-bold mb-4">New Habit</h2>
            <form id="addForm">
                <input type="text" id="newHabitName" placeholder="Habit Name" class="w-full mb-4 p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border-none outline-none">
                <div class="grid grid-cols-3 gap-2 mb-6">
                    <div onclick="selectCat('Health')" class="cat-opt p-2 rounded-lg border dark:border-gray-600 text-center cursor-pointer bg-indigo-100 border-primary" data-val="Health">ðŸ’ª</div>
                    <div onclick="selectCat('Study')" class="cat-opt p-2 rounded-lg border dark:border-gray-600 text-center cursor-pointer" data-val="Study">ðŸ“š</div>
                    <div onclick="selectCat('Work')" class="cat-opt p-2 rounded-lg border dark:border-gray-600 text-center cursor-pointer" data-val="Work">ðŸ’¼</div>
                </div>
                <input type="hidden" id="selectedCat" value="Health">
                <div class="flex gap-3">
                    <button type="button" onclick="document.getElementById('addModal').classList.add('hidden')" class="flex-1 py-2 text-gray-500">Cancel</button>
                    <button type="submit" class="flex-1 py-2 bg-primary text-white rounded-xl">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-full text-sm opacity-0 transition-opacity z-[60]">Action Saved</div>

    <script>
        // ----------------------------------------------------
        // YOUR NEW URL IS HERE:
        // ----------------------------------------------------
        const API_URL = "https://script.google.com/macros/s/AKfycbyR49IbVgw7Y1zazVTzFWETKrKn4IyTJo11zxro4gmhaMGsQKtXA0DTDHXVQyP0mpXCXQ/exec";
        
        const apiKey = ""; // Gemini API Key Injected by Runtime

        let habits = [];
        let logs = [];
        let selectedDate = new Date();
        let chartInstance = null;
        let isDarkMode = localStorage.getItem('theme') === 'dark';
        let processingIds = new Set(); // To prevent double clicks

        document.addEventListener('DOMContentLoaded', () => {
            if(isDarkMode) document.documentElement.classList.add('dark');
            updateDateDisplay();
            fetchData();
        });

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.documentElement.classList.toggle('dark', isDarkMode);
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            if(document.getElementById('view-analytics').classList.contains('hidden') === false) updateDashboard();
        }

        function switchTab(tab) {
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-analytics').classList.add('hidden');
            document.getElementById('view-' + tab).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('text-primary', 'text-gray-400'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.add('text-gray-400'));
            document.getElementById('btn-' + tab).classList.remove('text-gray-400');
            document.getElementById('btn-' + tab).classList.add('text-primary');

            if(tab === 'analytics') updateDashboard();
        }

        // --- FIXED DATE HANDLING ---
        const getLocalDateStr = (d) => {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        function updateDateDisplay() {
            const today = new Date();
            const isToday = getLocalDateStr(selectedDate) === getLocalDateStr(today);
            document.getElementById('currentDateDisplay').innerText = isToday ? "Today" : selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
            document.getElementById('currentFullDate').innerText = selectedDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
            renderHabits();
        }

        function changeDate(d) {
            selectedDate.setDate(selectedDate.getDate() + d);
            updateDateDisplay();
        }

        async function fetchData() {
            try {
                const res = await fetch(`${API_URL}?op=get_data`);
                const data = await res.json();
                if(data.status === 'success') {
                    habits = data.habits;
                    logs = data.logs;
                    renderHabits();
                    document.getElementById('loadingState').classList.add('hidden');
                }
            } catch(e) { console.error(e); }
        }

        function renderHabits() {
            const list = document.getElementById('habitsList');
            list.innerHTML = '';
            const dateStr = getLocalDateStr(selectedDate);
            
            if(habits.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            habits.forEach(h => {
                const isDone = logs.some(l => String(l.habit_id) === String(h.id) && String(l.date) === dateStr);
                const isProcessing = processingIds.has(h.id);

                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl flex items-center justify-between transition-all border ${isDone ? 'bg-indigo-50 border-indigo-200 dark:bg-indigo-900/10 dark:border-indigo-800' : 'bg-white border-gray-100 dark:bg-card dark:border-gray-800'}`;
                
                div.innerHTML = `
                    <div class="flex items-center gap-4 flex-1">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl bg-gray-100 dark:bg-gray-700">${getIcon(h.category)}</div>
                        <div>
                            <h3 class="font-bold ${isDone ? 'line-through text-gray-400' : ''}">${h.name}</h3>
                            <p class="text-xs text-gray-400">${h.category}</p>
                        </div>
                    </div>
                    <button onclick="toggleLog('${h.id}')" 
                        class="w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${isProcessing ? 'processing' : ''} ${isDone ? 'bg-primary border-primary text-white scale-110' : 'border-gray-300 text-transparent'}">
                        ${isProcessing ? '<div class="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>' : '<i class="fa-solid fa-check text-xs"></i>'}
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function getIcon(cat) {
            if(cat === 'Health') return 'ðŸ’ª'; if(cat === 'Study') return 'ðŸ“š'; if(cat === 'Work') return 'ðŸ’¼'; return 'âœ¨';
        }

        async function toggleLog(id) {
            if (processingIds.has(id)) return; // Stop double clicks
            processingIds.add(id);
            renderHabits(); // Show spinner

            const dateStr = getLocalDateStr(selectedDate);
            const idx = logs.findIndex(l => String(l.habit_id) === String(id) && String(l.date) === dateStr);
            
            if(idx > -1) logs.splice(idx, 1);
            else logs.push({habit_id: id, date: dateStr, status: 'done'});

            try {
                await fetch(API_URL, {
                    method: 'POST', body: JSON.stringify({op: 'toggle_log', habit_id: id, date: dateStr})
                });
            } catch(e) {
                console.error("Sync failed");
                showToast("Sync Error");
            } finally {
                processingIds.delete(id);
                renderHabits();
                showToast("Saved");
            }
        }

        // --- GEMINI AI ---
        function openAIModal() { document.getElementById('aiModal').classList.remove('hidden'); document.getElementById('aiPrompt').focus(); }
        function closeAIModal() { document.getElementById('aiModal').classList.add('hidden'); document.getElementById('aiResults').classList.add('hidden'); }

        async function askGemini() {
            const prompt = document.getElementById('aiPrompt').value;
            if(!prompt) return;
            const loading = document.getElementById('aiLoading');
            const results = document.getElementById('aiResults');
            loading.classList.remove('hidden'); results.classList.add('hidden');

            try {
                const systemPrompt = "You are a Habit Coach. Suggest 3 daily trackable habits for the user's goal. Return ONLY valid JSON array: [{'name': 'Run 5min', 'category': 'Health', 'emoji': 'ðŸƒ'}]. No markdown.";
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }]}, generationConfig: { responseMimeType: "application/json" } })
                });
                const data = await response.json();
                const items = JSON.parse(data.candidates[0].content.parts[0].text);
                
                results.innerHTML = '';
                results.classList.remove('hidden');
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center bg-gray-50 dark:bg-white/5 p-3 rounded-xl border border-gray-100 dark:border-white/10";
                    div.innerHTML = `<div class="flex gap-3 items-center"><span class="text-xl">${item.emoji}</span><div><h4 class="font-bold text-sm dark:text-gray-200">${item.name}</h4><span class="text-[10px] text-gray-400 uppercase">${item.category}</span></div></div><button onclick="addHabitDirect('${item.name}', '${item.category}')" class="bg-purple-600 text-white w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-plus text-xs"></i></button>`;
                    results.appendChild(div);
                });
            } catch(e) { console.error(e); showToast("AI Error"); } 
            finally { loading.classList.add('hidden'); }
        }

        async function addHabitDirect(name, category) {
            showToast("Adding...");
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({op: 'add_habit', name, category}) });
            const d = await res.json();
            if(d.status === 'success') {
                habits.push({id: d.id, name, category});
                renderHabits();
                showToast("Added!");
            }
        }

        // --- UTILS & ANALYTICS ---
        function selectCat(cat) {
            document.getElementById('selectedCat').value = cat;
            document.querySelectorAll('.cat-opt').forEach(el => el.classList.remove('bg-indigo-100', 'border-primary'));
            event.currentTarget.classList.add('bg-indigo-100', 'border-primary');
        }
        
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('newHabitName').value;
            const category = document.getElementById('selectedCat').value;
            addHabitDirect(name, category);
            document.getElementById('addModal').classList.add('hidden');
            document.getElementById('newHabitName').value = '';
        });

        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 2000);
        }

        function updateDashboard() {
            document.getElementById('stat-total-done').innerText = logs.length;
            const counts = {}; logs.forEach(l => counts[l.date] = (counts[l.date] || 0) + 1);
            document.getElementById('stat-best-streak').innerText = Math.max(0, ...Object.values(counts));
            
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            const labels = [], data = [];
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('en-US', {weekday: 'short'}));
                data.push(logs.filter(l => l.date === getLocalDateStr(d)).length);
            }
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Habits', data, backgroundColor: '#6366f1', borderRadius: 4 }] }, options: { responsive: true, scales: { y: { display: false }, x: { display: false } }, plugins: { legend: { display: false } } } });

            const hm = document.getElementById('yearHeatmap'); hm.innerHTML = '';
            for(let i=100; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const c = logs.filter(l => l.date === getLocalDateStr(d)).length;
                const div = document.createElement('div'); div.className = 'heatmap-cell';
                div.style.backgroundColor = c === 0 ? (isDarkMode ? '#334155' : '#e2e8f0') : (c < 3 ? '#818cf8' : '#4f46e5');
                hm.appendChild(div);
            }
        }
    </script>
</body>
</html>
