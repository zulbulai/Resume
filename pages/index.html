<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Camva Pro | CRM</title>
    
    <!-- 
       NOTE: Since this is a standalone HTML file without a build process (Node.js/Webpack),
       we MUST use the CDN links for Tailwind and Babel. The console warning regarding 
       "production" is normal for this setup and can be ignored for this use case.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media print {
            body * { visibility: hidden; }
            #invoice-modal, #invoice-modal * { visibility: visible; }
            #invoice-modal { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; z-index: 9999; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 h-screen overflow-hidden">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-presets="env,react">
        // ==========================================
        // ‚öôÔ∏è CONFIGURATION
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbyEv15qA-6DjcD54I-qt9aHbL6RmZo5_rSUO0KFaMw7NjGQw2c2WJv7WLd52YavIGOD/exec";
        const SUPPORT_PHONE = "+91 6387617678";
        const COMPANY_NAME = "Camva Pro Services";
        
        const PLANS = [
            { id: 'monthly', name: 'Monthly Plan', price: 49, months: 1 },
            { id: 'quarterly', name: 'Quarterly Plan', price: 99, months: 3 },
            { id: 'annually', name: 'Annual Plan', price: 299, months: 12 },
            { id: 'annually_adv', name: 'Annual Advance', price: 499, months: 12 },
        ];

        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 18, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current, attrs: { width: size, height: size, class: className } });
                }
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        // --- ROBUST DATE PARSING (Fixes "Invalid time value") ---
        const parseDate = (dStr) => {
            if (!dStr) return new Date(); // Return today if null
            try {
                // If it's already a Date object
                if (Object.prototype.toString.call(dStr) === '[object Date]') {
                    return isNaN(dStr.getTime()) ? new Date() : dStr;
                }
                
                // Try standard parsing
                let d = new Date(dStr);
                if (!isNaN(d.getTime())) return d;

                // Handle manual formats like "2024-12-25" or "25/12/2024" safely
                // This regex extracts digits to try and reconstruct
                const p = String(dStr).match(/(\d+)/g);
                if (!p || p.length < 3) return new Date();
                
                // Try ISO (YYYY-MM-DD)
                if (p[0].length === 4) return new Date(p[0], p[1]-1, p[2]);
                // Try UK/Indian (DD-MM-YYYY)
                if (p[2].length === 4) return new Date(p[2], p[1]-1, p[0]);
                
                return new Date(); // Fallback to now
            } catch(e) { 
                console.warn("Date parse error:", e);
                return new Date(); 
            }
        };

        const formatDate = (d) => {
            try {
                const date = parseDate(d);
                if (isNaN(date.getTime())) return 'N/A';
                return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            } catch (e) { return 'N/A'; }
        };
        
        const getDaysLeft = (expiry) => {
            try {
                const today = new Date(); today.setHours(0,0,0,0);
                const exp = parseDate(expiry); exp.setHours(0,0,0,0);
                if (isNaN(exp.getTime())) return 0;
                return Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
            } catch (e) { return 0; }
        };

        const formatCurrency = (amt) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(Number(amt) || 0);

        // --- WHATSAPP GENERATOR ---
        const generateWA = (customer, type) => {
            try {
                const name = customer.name ? customer.name.split(' ')[0] : 'User';
                const plan = customer.plan || 'Plan';
                const expiry = formatDate(customer.expiry);
                const days = getDaysLeft(customer.expiry);
                const phone = String(customer.phone || '').replace(/\D/g,'').slice(-10);
                
                if (!phone) { alert("Invalid Phone Number"); return; }

                let msg = "";
                switch(type) {
                    case 'welcome': msg = `üéâ *Welcome ${name}!* Your ${plan} is active till ${expiry}. Start creating! üöÄ`; break;
                    case 'reminder': msg = `‚è∞ *Reminder:* Your plan expires in *${days} days* (${expiry}). Renew now!`; break;
                    case 'renewed': msg = `‚úÖ *Renewed!* Thanks ${name}. Plan extended till ${expiry}.`; break;
                    case 'expired': msg = `‚ö†Ô∏è *Expired:* Your plan ended on ${expiry}. Renew to restore access.`; break;
                    case 'status': msg = `üìä *Status:* ${days < 0 ? 'Expired' : 'Active'}\nüìÖ Exp: ${expiry}\nüì¶ Plan: ${plan}`; break;
                }
                window.open(`https://wa.me/91${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            } catch(e) { console.error("WA Error", e); }
        };

        // --- MAIN APP ---
        const App = () => {
            const [customers, setCustomers] = useState([]);
            const [loading, setLoading] = useState(false);
            const [view, setView] = useState('dashboard');
            const [search, setSearch] = useState('');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [toast, setToast] = useState(null);
            
            // Actions Data
            const [editData, setEditData] = useState(null);
            const [renewData, setRenewData] = useState(null);
            const [invoiceData, setInvoiceData] = useState(null);
            const [msgUser, setMsgUser] = useState(null);

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 3000);
            };

            const refreshData = async () => {
                setLoading(true);
                try {
                    const res = await fetch(API_URL);
                    const json = await res.json();
                    if(json.status === 'success') {
                        setCustomers(json.data.sort((a,b) => {
                            // Safer sorting
                            const tA = parseDate(a.timestamp || a.joined).getTime();
                            const tB = parseDate(b.timestamp || b.joined).getTime();
                            return tB - tA;
                        }));
                    }
                } catch (e) { 
                    console.error(e); 
                    showToast("Failed to sync data");
                } finally { setLoading(false); }
            };

            useEffect(() => { refreshData(); }, []);

            const filteredList = useMemo(() => {
                let data = customers;
                if(view === 'expired') data = data.filter(c => getDaysLeft(c.expiry) < 0);
                if(view === 'week') data = data.filter(c => { const d = getDaysLeft(c.expiry); return d >= 0 && d <= 7; });
                return data.filter(c => (c.name && c.name.toLowerCase().includes(search.toLowerCase())) || (c.phone && String(c.phone).includes(search)));
            }, [customers, search, view]);

            const stats = useMemo(() => {
                const total = customers.length;
                const active = customers.filter(c => getDaysLeft(c.expiry) >= 0).length;
                const expired = total - active;
                const thisWeek = customers.filter(c => { const d = getDaysLeft(c.expiry); return d >= 0 && d <= 7; }).length;
                const revenue = customers.reduce((acc, c) => acc + (Number(c.lifetime_value) || Number(c.payment) || 0), 0);
                return { total, active, expired, thisWeek, revenue };
            }, [customers]);

            // Safe Revenue Data
            const revenueData = useMemo(() => {
                try {
                    const monthly = {};
                    customers.forEach(c => {
                        const d = parseDate(c.joined);
                        if(isNaN(d.getTime())) return;
                        const key = d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                        const amt = Number(c.payment) || 0;
                        if(!monthly[key]) monthly[key] = 0;
                        monthly[key] += amt;
                    });
                    const chartData = Object.keys(monthly).map(k => ({ label: k, value: monthly[k] }));
                    const maxVal = Math.max(...chartData.map(d => d.value), 1);
                    return { data: chartData, max: maxVal };
                } catch(e) { return { data: [], max: 100 }; }
            }, [customers]);

            const navigate = (v) => { setView(v); setSidebarOpen(false); setSearch(''); };

            // --- SAFE RENEW HANDLER ---
            const handleRenewProcess = async (planId) => {
                try {
                    const plan = PLANS.find(x => x.id === planId);
                    if (!plan || !renewData) return;

                    const today = new Date();
                    let start = parseDate(renewData.expiry);
                    // If expired, start from today, else extend
                    if(start < today || isNaN(start.getTime())) start = today;
                    
                    // Add months safely
                    const newExpDate = new Date(start);
                    newExpDate.setMonth(newExpDate.getMonth() + (plan.months || 1));
                    
                    const newExp = newExpDate.toISOString().split('T')[0];
                    
                    // Reminder 3 days before
                    const newRemDate = new Date(newExpDate);
                    newRemDate.setDate(newRemDate.getDate() - 3);
                    const newRem = newRemDate.toISOString().split('T')[0];
                    
                    const updated = {
                        ...renewData,
                        plan: planId,
                        expiry: newExp,
                        status: 'Active',
                        last_payment: plan.price,
                        lifetime_value: (Number(renewData.lifetime_value) || 0) + plan.price,
                        timestamp: new Date().toISOString()
                    };
                    
                    setCustomers(prev => prev.map(c => c.id === renewData.id ? updated : c));
                    setRenewData(null);
                    showToast("Plan Renewed Successfully!");
                    generateWA(updated, 'renewed');

                    await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'renew',
                            data: {
                                id: renewData.id,
                                plan: planId,
                                payment: plan.price,
                                expiry: newExp,
                                reminder: newRem
                            }
                        })
                    });
                } catch(e) {
                    console.error(e);
                    alert("Error processing renewal. Check console.");
                }
            };

            return (
                <div className="flex h-full bg-slate-50">
                    {/* Toast Notification */}
                    {toast && (
                        <div className="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-lg z-[60] fade-in flex items-center gap-2">
                            <Icon name="check-circle" size={16} className="text-emerald-400" /> {toast}
                        </div>
                    )}

                    {sidebarOpen && <div onClick={()=>setSidebarOpen(false)} className="fixed inset-0 bg-black/50 z-40 md:hidden fade-in"></div>}
                    
                    <aside className={`fixed md:static inset-y-0 left-0 w-72 bg-slate-900 text-white z-50 transform transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'} flex flex-col shadow-2xl`}>
                        <div className="p-6 border-b border-slate-800 flex justify-between items-center">
                            <h1 className="text-xl font-bold flex items-center gap-2"><Icon name="crown" className="text-yellow-400" /> Camva Pro</h1>
                            <button onClick={()=>setSidebarOpen(false)} className="md:hidden"><Icon name="x" /></button>
                        </div>
                        <nav className="flex-1 overflow-y-auto p-4 space-y-2">
                            <NavItem active={view==='dashboard'} onClick={()=>navigate('dashboard')} icon="layout-dashboard" label="Dashboard" />
                            <NavItem active={view==='revenue'} onClick={()=>navigate('revenue')} icon="bar-chart-3" label="Revenue Analysis" color="text-purple-400" />
                            <NavItem active={view==='list'} onClick={()=>navigate('list')} icon="users" label="All Customers" />
                            <NavItem active={view==='week'} onClick={()=>navigate('week')} icon="calendar-clock" label="Expiring Soon" badge={stats.thisWeek} color="bg-orange-500" />
                            <NavItem active={view==='expired'} onClick={()=>navigate('expired')} icon="alert-octagon" label="Expired Plans" badge={stats.expired} color="bg-red-500" />
                            <div className="pt-4 mt-4 border-t border-slate-800">
                                <p className="text-xs font-bold text-slate-500 uppercase px-4 mb-2">Actions</p>
                                <NavItem active={view==='add'} onClick={()=>{setEditData(null); navigate('add');}} icon="user-plus" label="Add Customer" />
                                <NavItem active={view==='import'} onClick={()=>{setEditData(null); navigate('import');}} icon="upload-cloud" label="Import Data" />
                            </div>
                        </nav>
                        <div className="p-4 bg-slate-800"><button onClick={refreshData} className="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold flex justify-center items-center gap-2 transition">{loading ? '...' : 'Sync Data'}</button></div>
                    </aside>

                    <main className="flex-1 flex flex-col h-full overflow-hidden relative">
                        <header className="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm shrink-0 z-10 sticky top-0">
                            <div className="flex items-center gap-3">
                                <button onClick={()=>setSidebarOpen(true)} className="md:hidden p-2 bg-slate-100 rounded-lg"><Icon name="menu" /></button>
                                <h2 className="text-lg font-bold text-slate-800 capitalize">{view.replace('_', ' ')}</h2>
                            </div>
                            <div className="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold border border-indigo-100">{formatCurrency(stats.revenue)}</div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-50">
                            
                            {/* DASHBOARD VIEW */}
                            {view === 'dashboard' && (
                                <div className="space-y-4 pb-20 fade-in">
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <StatCard label="Total" val={stats.total} icon="users" col="bg-blue-500" />
                                        <StatCard label="Active" val={stats.active} icon="check-circle" col="bg-emerald-500" />
                                        <StatCard label="Expiring" val={stats.thisWeek} icon="clock" col="bg-orange-500" onClick={()=>navigate('week')} />
                                        <StatCard label="Expired" val={stats.expired} icon="alert-triangle" col="bg-red-500" onClick={()=>navigate('expired')} />
                                    </div>
                                    
                                    {/* Revenue Teaser */}
                                    <div onClick={()=>navigate('revenue')} className="cursor-pointer bg-gradient-to-r from-indigo-600 to-purple-600 p-6 rounded-2xl text-white shadow-lg relative overflow-hidden group">
                                        <div className="relative z-10 flex justify-between items-center">
                                            <div>
                                                <p className="text-indigo-100 font-bold uppercase text-xs tracking-wider mb-1">Total Revenue</p>
                                                <h3 className="text-3xl font-extrabold">{formatCurrency(stats.revenue)}</h3>
                                            </div>
                                            <Icon name="bar-chart-3" size={40} className="opacity-80 group-hover:scale-110 transition" />
                                        </div>
                                        <div className="absolute -bottom-4 -right-4 text-white opacity-10"><Icon name="dollar-sign" size={120} /></div>
                                    </div>

                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                        <h3 className="font-bold mb-4">Quick Actions</h3>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={()=>{setEditData(null); navigate('add')}} className="p-4 bg-indigo-50 text-indigo-700 rounded-xl font-bold flex flex-col items-center gap-2 hover:bg-indigo-100 transition"><Icon name="user-plus" /> Add Customer</button>
                                            <button onClick={()=>{setEditData(null); navigate('import')}} className="p-4 bg-slate-100 text-slate-700 rounded-xl font-bold flex flex-col items-center gap-2 hover:bg-slate-200 transition"><Icon name="upload" /> Import Data</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* REVENUE VIEW */}
                            {view === 'revenue' && (
                                <div className="space-y-6 fade-in pb-20">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                                            <p className="text-slate-400 text-xs font-bold uppercase">Lifetime Earnings</p>
                                            <h3 className="text-2xl font-bold text-slate-800 mt-1">{formatCurrency(stats.revenue)}</h3>
                                        </div>
                                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                                            <p className="text-slate-400 text-xs font-bold uppercase">Best Month</p>
                                            <h3 className="text-2xl font-bold text-emerald-600 mt-1">
                                                {revenueData.data.length > 0 
                                                    ? revenueData.data.reduce((a, b) => a.value > b.value ? a : b).label 
                                                    : '-'}
                                            </h3>
                                        </div>
                                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                                            <p className="text-slate-400 text-xs font-bold uppercase">Avg. per User</p>
                                            <h3 className="text-2xl font-bold text-blue-600 mt-1">
                                                {stats.total > 0 ? formatCurrency(stats.revenue / stats.total) : '‚Çπ0'}
                                            </h3>
                                        </div>
                                    </div>

                                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                                        <h3 className="font-bold text-lg mb-6 text-slate-800 flex items-center gap-2">
                                            <Icon name="bar-chart-3" className="text-indigo-500"/> Monthly Acquisition
                                        </h3>
                                        
                                        <div className="h-64 flex items-end gap-2 sm:gap-4">
                                            {revenueData.data.length === 0 ? (
                                                <div className="w-full h-full flex items-center justify-center text-slate-400">No data available</div>
                                            ) : (
                                                revenueData.data.map((item, idx) => {
                                                    const heightPercent = Math.max((item.value / revenueData.max) * 100, 5);
                                                    return (
                                                        <div key={idx} className="flex-1 flex flex-col items-center group">
                                                            <div className="relative w-full flex justify-center items-end h-full">
                                                                <div 
                                                                    className="w-full max-w-[40px] bg-indigo-100 group-hover:bg-indigo-500 transition-all duration-300 rounded-t-lg relative"
                                                                    style={{ height: `${heightPercent}%` }}
                                                                >
                                                                    <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                                                                        {formatCurrency(item.value)}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <p className="text-[10px] sm:text-xs font-bold text-slate-400 mt-2 rotate-0 sm:rotate-0 truncate w-full text-center">{item.label}</p>
                                                        </div>
                                                    );
                                                })
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* LIST VIEWS */}
                            {['list', 'expired', 'week'].includes(view) && (
                                <div className="space-y-4 pb-20 fade-in">
                                    <div className="relative">
                                        <div className="absolute left-3 top-3.5 text-slate-400"><Icon name="search" size={18} /></div>
                                        <input type="text" placeholder="Search name or phone..." className="w-full pl-10 p-3 rounded-xl border outline-none focus:border-indigo-500 bg-white shadow-sm" value={search} onChange={e=>setSearch(e.target.value)} />
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                                        {filteredList.map(c => (
                                            <CustomerCard 
                                                key={c.id} 
                                                data={c} 
                                                onRenew={()=>setRenewData(c)} 
                                                onEdit={()=>{setEditData(c); navigate('add');}} 
                                                onMsg={()=>setMsgUser(c)}
                                                onInvoice={()=>setInvoiceData(c)}
                                            />
                                        ))}
                                    </div>
                                    {filteredList.length === 0 && <div className="text-center py-10 text-slate-400">No customers found</div>}
                                </div>
                            )}

                            {/* FORM VIEW */}
                            {['add', 'import'].includes(view) && (
                                <FormView mode={view} editData={editData} onCancel={()=>navigate('list')} onSuccess={()=>{ refreshData(); navigate('list'); }} />
                            )}
                        </div>
                    </main>

                    {/* --- MODALS --- */}

                    {/* MESSAGE PANEL */}
                    {msgUser && (
                        <div className="fixed inset-0 z-50 flex items-end justify-center sm:items-center">
                            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm fade-in" onClick={()=>setMsgUser(null)}></div>
                            <div className="relative bg-white w-full max-w-md sm:rounded-2xl rounded-t-3xl shadow-2xl slide-up max-h-[85vh] flex flex-col">
                                <div className="p-4 border-b bg-slate-50 flex justify-between items-center sticky top-0">
                                    <h3 className="font-bold text-lg">Message {msgUser.name.split(' ')[0]}</h3>
                                    <button onClick={()=>setMsgUser(null)} className="p-2 bg-slate-200 rounded-full"><Icon name="x" size={16}/></button>
                                </div>
                                <div className="p-4 overflow-y-auto bg-white grid grid-cols-2 gap-3 pb-8">
                                    <TemplateBtn title="Welcome" icon="sparkles" color="bg-blue-600" onClick={()=>generateWA(msgUser, 'welcome')} />
                                    <TemplateBtn title="Reminder" icon="clock" color="bg-orange-500" full onClick={()=>generateWA(msgUser, 'reminder')} />
                                    <TemplateBtn title="Renewed" icon="check-circle" color="bg-emerald-600" onClick={()=>generateWA(msgUser, 'renewed')} />
                                    <TemplateBtn title="Expired" icon="alert-triangle" color="bg-red-600" onClick={()=>generateWA(msgUser, 'expired')} />
                                    <TemplateBtn title="Status" icon="info" color="bg-cyan-600" full onClick={()=>generateWA(msgUser, 'status')} />
                                </div>
                            </div>
                        </div>
                    )}

                    {/* RENEW MODAL */}
                    {renewData && (
                        <div className="fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl w-full max-w-sm p-4 fade-in">
                                <div className="flex justify-between mb-4"><h3 className="font-bold text-lg">Renew Subscription</h3><button onClick={()=>setRenewData(null)}><Icon name="x"/></button></div>
                                <div className="space-y-2">
                                    {PLANS.map(p => (
                                        <button key={p.id} type="button" onClick={() => handleRenewProcess(p.id)} className="w-full flex justify-between p-3 rounded-xl border hover:bg-indigo-50 border-slate-200 transition">
                                            <span className="font-medium">{p.name}</span><span className="font-bold text-indigo-600">‚Çπ{p.price}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* INVOICE MODAL */}
                    {invoiceData && (
                        <div className="fixed inset-0 bg-slate-900/90 z-50 flex items-center justify-center p-2">
                            <div className="bg-white w-full max-w-lg rounded-xl overflow-hidden flex flex-col max-h-[90vh]">
                                <div className="p-4 border-b flex justify-between no-print bg-slate-50"><h3 className="font-bold">Invoice Preview</h3><button onClick={()=>setInvoiceData(null)}><Icon name="x"/></button></div>
                                <div id="invoice-modal" className="p-8 overflow-y-auto flex-1 bg-white">
                                    <div className="flex justify-between mb-6 border-b pb-4">
                                        <div><h1 className="text-3xl font-extrabold text-slate-800">INVOICE</h1><p className="text-sm text-slate-500 font-mono">#{Date.now().toString().slice(-6)}</p></div>
                                        <div className="text-right"><h2 className="font-bold text-indigo-600 text-lg">{COMPANY_NAME}</h2><p className="text-xs text-slate-500">{new Date().toLocaleDateString()}</p></div>
                                    </div>
                                    <div className="mb-6">
                                        <p className="text-xs text-slate-400 uppercase font-bold mb-1">Bill To:</p>
                                        <h3 className="font-bold text-lg">{invoiceData.name}</h3>
                                        <p className="text-sm text-slate-600">{invoiceData.email}</p>
                                        <p className="text-sm text-slate-600">{invoiceData.phone}</p>
                                    </div>
                                    <table className="w-full mb-6 text-sm border-collapse">
                                        <thead><tr className="border-b border-slate-200"><th className="text-left py-2 font-bold text-slate-500">Description</th><th className="text-right py-2 font-bold text-slate-500">Amount</th></tr></thead>
                                        <tbody><tr><td className="py-4 font-medium">Camva Pro Subscription ({invoiceData.plan})<br/><span className="text-xs text-slate-400 font-normal">Valid until {formatDate(invoiceData.expiry)}</span></td><td className="text-right py-4 font-bold">‚Çπ{invoiceData.payment}</td></tr></tbody>
                                        <tfoot><tr className="border-t border-slate-200"><td className="py-4 font-bold text-slate-800">Total</td><td className="text-right py-4 font-bold text-indigo-600 text-lg">‚Çπ{invoiceData.payment}</td></tr></tfoot>
                                    </table>
                                    <div className="text-center text-xs text-slate-400 mt-8 border-t pt-4"><p>Thank you for your business!</p><p>Contact: {SUPPORT_PHONE}</p></div>
                                </div>
                                <div className="p-4 border-t bg-slate-50 flex justify-end gap-2 no-print">
                                    <button onClick={()=>window.print()} className="px-6 py-2 bg-indigo-600 text-white rounded-lg flex items-center gap-2 hover:bg-indigo-700 font-bold shadow-lg"><Icon name="printer" size={18}/> Print / PDF</button>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        // --- SUB COMPONENTS ---
        const NavItem = ({ active, onClick, icon, label, badge, color }) => (
            <button onClick={onClick} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition ${active ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' : 'text-slate-400 hover:bg-slate-800'}`}>
                <Icon name={icon} size={20} className={active ? 'text-white' : color} />
                <span className="flex-1 text-left font-medium">{label}</span>
                {badge > 0 && <span className={`text-[10px] px-2 py-0.5 rounded-full text-white ${color}`}>{badge}</span>}
            </button>
        );

        const StatCard = ({ label, val, icon, col, onClick }) => (
            <div onClick={onClick} className={`bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-3 active:scale-95 transition ${onClick ? 'cursor-pointer hover:shadow-md' : ''}`}>
                <div className={`p-3 rounded-lg text-white ${col}`}><Icon name={icon} /></div>
                <div><p className="text-xs text-slate-500 font-bold uppercase">{label}</p><h4 className="text-xl font-bold">{val}</h4></div>
            </div>
        );

        const TemplateBtn = ({ title, icon, color, onClick, full }) => (
            <button onClick={onClick} className={`p-4 rounded-xl text-white shadow-md flex flex-col items-center justify-center gap-2 active:scale-95 transition ${color} ${full ? 'col-span-2' : ''}`}>
                <Icon name={icon} size={24} />
                <span className="text-xs font-bold uppercase tracking-wide">{title}</span>
            </button>
        );

        const CustomerCard = ({ data, onRenew, onEdit, onMsg, onInvoice }) => {
            const daysLeft = getDaysLeft(data.expiry);
            const isExpired = daysLeft < 0;
            return (
                <div className="bg-white rounded-2xl p-5 shadow-sm border border-slate-200 flex flex-col relative hover:shadow-md transition">
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <h3 className="font-bold text-slate-800 text-lg">{data.name || 'User'}</h3>
                            <span className="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded uppercase tracking-wider">{data.plan}</span>
                        </div>
                        <div className={`px-2 py-1 rounded text-xs font-bold ${isExpired ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}`}>{isExpired ? 'EXPIRED' : 'ACTIVE'}</div>
                    </div>

                    <div className="space-y-3 text-sm text-slate-700 mb-4 border-t border-slate-100 pt-3">
                        <div className="flex items-center gap-2"><Icon name="mail" size={14} className="text-indigo-500"/> <span className="truncate">{data.email}</span></div>
                        <div className="flex items-center gap-2"><Icon name="phone" size={14} className="text-indigo-500"/> <span>{data.phone}</span></div>
                        
                        <div className="grid grid-cols-2 gap-y-3 gap-x-2 mt-3 bg-slate-50 p-3 rounded-xl border border-slate-100 text-xs">
                            <div><span className="text-slate-400 font-bold uppercase block mb-0.5">Joined</span><span className="font-medium text-slate-800">{formatDate(data.joined)}</span></div>
                            <div><span className="text-slate-400 font-bold uppercase block mb-0.5">Renew Date</span><span className="font-medium text-slate-800">{data.timestamp ? formatDate(data.timestamp) : '-'}</span></div>
                            <div><span className="text-slate-400 font-bold uppercase block mb-0.5">Expiry</span><span className={isExpired ? 'text-red-600 font-bold' : 'text-emerald-600 font-bold'}>{formatDate(data.expiry)}</span></div>
                            <div><span className="text-slate-400 font-bold uppercase block mb-0.5">Payment</span><span className="text-indigo-600 font-bold">‚Çπ{data.payment}</span></div>
                        </div>
                    </div>

                    {data.notes && (
                        <div className="bg-amber-50 border border-amber-100 p-3 rounded-xl mb-4 text-xs text-amber-900 relative">
                            <div className="flex items-center gap-1 mb-1 font-bold text-amber-600 uppercase text-[10px]"><Icon name="sticky-note" size={12} /> Note:</div>
                            <p className="italic">{data.notes}</p>
                        </div>
                    )}

                    <div className="grid grid-cols-2 gap-3 mt-auto border-t border-slate-100 pt-3">
                        <button onClick={onMsg} className="py-2.5 bg-green-100 text-green-700 rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-green-200 transition border border-green-200 shadow-sm"><Icon name="message-circle" size={16}/> Chat</button>
                        <button onClick={onEdit} className="py-2.5 bg-slate-100 text-slate-700 rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-slate-200 transition border border-slate-200 shadow-sm"><Icon name="edit-3" size={16}/> Edit</button>
                        <button onClick={onInvoice} className="py-2.5 bg-orange-100 text-orange-700 rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-orange-200 transition border border-orange-100 shadow-sm"><Icon name="printer" size={16}/> Bill</button>
                        <button onClick={onRenew} className="py-2.5 bg-indigo-600 text-white rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-indigo-700 transition shadow-md shadow-indigo-200"><Icon name="refresh-cw" size={16}/> Renew</button>
                    </div>
                </div>
            );
        };

        const FormView = ({ mode, editData, onCancel, onSuccess }) => {
            const [form, setForm] = useState({ name:'', email:'', phone:'', team:'', plan:'monthly', joined: new Date().toISOString().split('T')[0], expiry:'', payment:49, notes: '' });
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if(editData) setForm({ 
                    ...editData, 
                    phone: String(editData.phone).replace(/\D/g,''), 
                    joined: editData.joined?.split('T')[0], 
                    expiry: editData.expiry?.split('T')[0], 
                    notes: editData.notes || '' 
                });
                else { 
                    const d = new Date(); d.setMonth(d.getMonth() + 1); 
                    setForm(prev => ({...prev, expiry: d.toISOString().split('T')[0]})); 
                }
            }, [editData]);

            const calcExpiry = (dStr, pId) => {
                const p = PLANS.find(x=>x.id===pId);
                // Safe date check
                if (!dStr || dStr === 'Invalid Date') return;
                
                if(mode==='import') { 
                    setForm(prev => ({...prev, joined: dStr, plan: pId, payment: p.price})); 
                    return; 
                }

                const d = new Date(dStr);
                if (isNaN(d.getTime())) return; // Prevent invalid time value
                
                d.setMonth(d.getMonth() + (p.months || 1));
                setForm(prev=>({...prev, joined:dStr, plan:pId, payment:p.price, expiry:d.toISOString().split('T')[0]}));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                const action = editData ? 'update' : 'add';
                
                // --- SAFE DATE FIX FOR PAYLOAD ---
                let reminderStr = "";
                const expDate = parseDate(form.expiry);
                
                if(!isNaN(expDate.getTime())) {
                   const remDate = new Date(expDate); 
                   remDate.setDate(remDate.getDate() - 3);
                   reminderStr = remDate.toISOString().split('T')[0];
                } else {
                    alert("Invalid Expiry Date");
                    setLoading(false);
                    return;
                }

                const payload = { ...form, id: editData?.id, reminder: reminderStr };
                try {
                    await fetch(API_URL, { method:'POST', body: JSON.stringify({ action, data: payload }) });
                    if(action==='add' && mode!=='import') generateWA({ ...payload, plan: PLANS.find(x=>x.id===payload.plan).name }, 'welcome');
                    onSuccess();
                } catch(e) { alert("Error saving data"); } finally { setLoading(false); }
            };

            return (
                <div className="bg-white rounded-2xl shadow border border-slate-200 p-4 max-w-2xl mx-auto mt-4 fade-in">
                    <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-lg">{editData ? 'Edit' : 'Add'} Customer</h3><button onClick={onCancel}><Icon name="x"/></button></div>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-2 gap-4"><input required className="p-3 border rounded-xl w-full" placeholder="Name" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} /><input className="p-3 border rounded-xl w-full" placeholder="Team" value={form.team} onChange={e=>setForm({...form, team:e.target.value})} /></div>
                        <input required type="tel" className="p-3 border rounded-xl w-full" placeholder="Phone" value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})} />
                        <input required type="email" className="p-3 border rounded-xl w-full" placeholder="Email" value={form.email} onChange={e=>setForm({...form, email:e.target.value})} />
                        
                        <div className="grid grid-cols-2 gap-2">{PLANS.map(p => <button type="button" key={p.id} onClick={()=>calcExpiry(form.joined, p.id)} className={`p-2 border rounded-lg text-xs font-bold transition ${form.plan===p.id ? 'bg-indigo-600 text-white shadow-md' : 'hover:bg-slate-50'}`}>{p.name}<br/>‚Çπ{p.price}</button>)}</div>
                        
                        <div className="grid grid-cols-2 gap-4"><input type="date" className="p-3 border rounded-xl" value={form.joined} onChange={e=>calcExpiry(e.target.value, form.plan)} /><input type="date" className="p-3 border rounded-xl bg-slate-100" readOnly={mode!=='import'} value={form.expiry} onChange={e=>setForm({...form, expiry:e.target.value})} /></div>
                        <textarea className="w-full p-3 border rounded-xl" placeholder="Notes..." value={form.notes} onChange={e=>setForm({...form, notes:e.target.value})}></textarea>
                        <button disabled={loading} className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold flex justify-center gap-2 hover:bg-indigo-700 transition shadow-lg">{loading && <Icon name="loader-2" className="animate-spin" />} Save</button>
                    </form>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


